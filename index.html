<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BusTrack | Real-Time School Bus Tracking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <style>
        :root {
            --primary-blue: #2563eb;
            --secondary-blue: #1d4ed8;
            --accent-blue: #3b82f6;
            --gradient-start: #2563eb;
            --gradient-end: #1e40af;
        }
        
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        
        #map { 
            position: absolute; 
            top: 0; 
            bottom: 0; 
            width: 100%; 
            z-index: 0;
        }
        
        /* Login Screen */
        .login-screen {
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
        }
        
        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary-blue);
            border: 2px solid var(--primary-blue);
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .btn-secondary:hover {
            background: rgba(37, 99, 235, 0.05);
        }
        
        /* Role Selection */
        .role-option {
            flex: 1;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .role-option:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }
        
        .role-option.selected {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }
        
        .role-icon {
            font-size: 24px;
            margin-bottom: 12px;
            color: var(--primary-blue);
        }
        
        /* Bottom Sheet */
        .bottom-sheet {
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1000;
            max-height: 85vh;
            overflow-y: auto;
            overscroll-behavior: contain;
        }
        
        .glass-nav {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
        }
        
        .bottom-sheet-handle {
            width: 40px;
            height: 5px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        /* Animations */
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        .slide-up {
            animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        .bounce-animation {
            animation: bounce 1s infinite;
        }
        
        /* Status Bar */
        .status-bar {
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        /* Bus Marker */
        .bus-marker {
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
            transition: all 0.3s ease;
        }
        
        /* Progress Bar */
        .progress-bar {
            height: 4px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        
        /* Card Styles */
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-left: 4px solid var(--accent-blue);
            max-width: 320px;
            animation: slideUp 0.3s ease-out;
            display: none;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            display: none;
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 4000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            display: none;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--accent-blue);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Loading Screen -->
    <div id="loading-screen" class="login-screen">
        <div class="text-center text-white animate__animated animate__fadeIn">
            <div class="w-24 h-24 bg-white rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-2xl animate__animated animate__pulse animate__infinite">
                <i class="fas fa-bus text-4xl" style="background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
            </div>
            <h1 class="text-5xl font-black mb-4 animate__animated animate__fadeInDown">BusTrack</h1>
            <p class="text-white/90 text-lg mb-12 animate__animated animate__fadeIn animate__delay-1s">Safe journeys, happy parents</p>
            
            <div class="w-64 h-2 bg-white/30 rounded-full overflow-hidden mx-auto animate__animated animate__fadeIn animate__delay-2s">
                <div id="loading-bar" class="h-full bg-white rounded-full w-0 transition-all duration-300"></div>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="login-screen hidden">
        <div class="login-card animate__animated animate__fadeInUp">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-bus text-2xl text-white"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Welcome to BusTrack</h2>
                <p class="text-gray-600 mt-2">Choose your role to continue</p>
            </div>
            
            <!-- Role Selection -->
            <div class="flex gap-3 mb-6">
                <div class="role-option" onclick="selectRole('driver')">
                    <i class="fas fa-tachometer-alt role-icon"></i>
                    <div class="font-semibold text-gray-800">Driver</div>
                    <div class="text-xs text-gray-500 mt-1">Manage routes</div>
                </div>
                <div class="role-option" onclick="selectRole('parent')">
                    <i class="fas fa-user-friends role-icon"></i>
                    <div class="font-semibold text-gray-800">Parent</div>
                    <div class="text-xs text-gray-500 mt-1">Track children</div>
                </div>
            </div>
            
            <!-- Login Form -->
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label" for="email">Email Address</label>
                    <input type="email" id="email" class="form-input" placeholder="driver@demo.com" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="password">Password</label>
                    <input type="password" id="password" class="form-input" placeholder="••••••••" required>
                </div>
                
                <div class="form-group flex items-center justify-between">
                    <label class="flex items-center">
                        <input type="checkbox" id="remember-me" class="mr-2">
                        <span class="text-sm text-gray-600">Remember me</span>
                    </label>
                    <a href="#" onclick="showForgotPassword()" class="text-sm text-blue-600 hover:text-blue-800 font-medium">Forgot password?</a>
                </div>
                
                <button type="submit" class="btn-primary mb-4">
                    Sign In
                </button>
                
                <div class="text-center">
                    <span class="text-gray-600 text-sm">Don't have an account?</span>
                    <a href="#" onclick="showSignup()" class="text-blue-600 hover:text-blue-800 font-medium text-sm ml-1">Sign up</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Top Navigation -->
    <div id="top-nav" class="hidden absolute top-0 left-0 right-0 z-40 pt-8 px-4">
        <div class="flex justify-between items-center">
            <!-- Left: Back Button -->
            <button onclick="logout()" class="w-12 h-12 glass-nav rounded-2xl shadow-lg border border-white/30 flex items-center justify-center hover:scale-105 transition-transform">
                <i class="fas fa-sign-out-alt text-gray-700"></i>
            </button>
            
            <!-- Center: Status -->
            <div class="flex-1 mx-4">
                <div id="parent-status" class="hidden glass-nav rounded-2xl shadow-lg border border-white/30 p-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <div class="bg-green-500 w-3 h-3 rounded-full"></div>
                                <div class="bg-green-500 w-3 h-3 rounded-full absolute top-0 pulse-animation"></div>
                            </div>
                            <div>
                                <p class="text-xs uppercase tracking-wider text-gray-500 font-bold">ETA</p>
                                <p class="font-bold text-gray-900"><span id="eta-time">8</span> min</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-500">Next Stop</p>
                            <p class="text-sm font-bold text-gray-900" id="next-stop-name">Oak Street</p>
                        </div>
                    </div>
                    <div class="progress-bar mt-2">
                        <div id="route-progress" class="progress-fill" style="width: 40%"></div>
                    </div>
                </div>
                
                <div id="driver-status" class="hidden glass-nav rounded-2xl shadow-lg border border-white/30 p-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs uppercase tracking-wider text-gray-500 font-bold" id="route-number">Route #402</p>
                            <p class="text-sm font-bold text-gray-900" id="route-name">Downtown Academy</p>
                        </div>
                        <div id="driver-status-badge" class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold uppercase">
                            <i class="fas fa-circle text-xs mr-1"></i>
                            Offline
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right: User Menu -->
            <div class="flex gap-2">
                <button onclick="refreshData()" class="w-12 h-12 glass-nav rounded-2xl shadow-lg border border-white/30 flex items-center justify-center hover:scale-105 transition-transform">
                    <i class="fas fa-sync-alt text-gray-700"></i>
                </button>
                <button onclick="showUserMenu()" class="w-12 h-12 glass-nav rounded-2xl shadow-lg border border-white/30 flex items-center justify-center hover:scale-105 transition-transform">
                    <i class="fas fa-user text-gray-700"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Sheet -->
    <div id="bottom-sheet" class="hidden fixed bottom-0 left-0 right-0 glass-nav rounded-t-3xl shadow-2xl bottom-sheet"
         style="transform: translateY(calc(100% - 60px));">
        
        <!-- Handle -->
        <div class="flex justify-center pt-3 pb-2" onclick="toggleBottomSheet()">
            <div class="bottom-sheet-handle"></div>
        </div>
        
        <!-- Content -->
        <div class="px-5 pb-8">
            
            <!-- Driver UI -->
            <div id="driver-ui" class="hidden">
                <!-- Header -->
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900" id="driver-route-name">Route #402</h2>
                        <p class="text-gray-600 text-sm flex items-center gap-2 mt-1">
                            <i class="fas fa-route text-xs"></i>
                            <span id="driver-destination">Downtown Academy Express</span>
                        </p>
                    </div>
                    <div class="text-right">
                        <div id="current-time" class="text-lg font-black text-gray-900">--:--</div>
                        <div class="text-xs text-gray-500">Local Time</div>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div class="stat-card" onclick="showStudentList()">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-user-graduate text-sm text-blue-600"></i>
                            <p class="text-xs text-blue-600 font-semibold">Students</p>
                        </div>
                        <p class="text-2xl font-bold text-blue-900"><span id="student-count">24</span><span class="text-sm text-blue-600">/30</span></p>
                        <div class="text-xs text-gray-500 mt-1">On board</div>
                    </div>
                    
                    <div class="stat-card" onclick="showNextStopDetails()">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-map-marker-alt text-sm text-yellow-600"></i>
                            <p class="text-xs text-yellow-600 font-semibold">Next Stop</p>
                        </div>
                        <p class="text-lg font-bold text-yellow-900" id="driver-next-stop">Oak St.</p>
                        <div class="text-xs text-gray-500 mt-1" id="next-stop-eta">7 min</div>
                    </div>
                    
                    <div class="stat-card" onclick="showSchedule()">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-clock text-sm text-green-600"></i>
                            <p class="text-xs text-green-600 font-semibold">On Time</p>
                        </div>
                        <p class="text-lg font-bold text-green-900">+2 min</p>
                        <div class="text-xs text-gray-500 mt-1">Ahead of schedule</div>
                    </div>
                </div>
                
                <!-- Route Progress -->
                <div class="bg-gray-50 rounded-2xl p-4 mb-6 border border-gray-200">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-gray-900 flex items-center gap-2">
                            <i class="fas fa-road text-sm"></i>
                            Route Progress
                        </h3>
                        <button onclick="showFullRoute()" class="text-xs text-blue-600 font-medium hover:text-blue-800">View All</button>
                    </div>
                    
                    <div class="space-y-3" id="route-stops-list">
                        <!-- Stops will be populated here -->
                    </div>
                </div>
                
                <!-- Action Button -->
                <button id="toggle-trip" onclick="toggleTrip()" class="btn-primary hover:scale-[1.02] transition-transform">
                    <i class="fas fa-play mr-2"></i>
                    <span>Start Trip</span>
                </button>
            </div>
            
            <!-- Parent UI -->
            <div id="parent-ui" class="hidden">
                <!-- Child Info -->
                <div class="flex items-center gap-4 mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl border border-blue-200">
                    <img id="child-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Leo" class="w-16 h-16 rounded-2xl shadow-lg" alt="Child">
                    <div class="flex-1">
                        <h2 class="text-xl font-bold text-gray-900" id="child-name">Leo's Journey</h2>
                        <p class="text-gray-600 text-sm flex items-center gap-2 mt-1">
                            <i class="fas fa-bus text-xs"></i>
                            <span id="bus-info">Bus 402 • Driver: Mike</span>
                        </p>
                    </div>
                    <div class="relative" onclick="toggleChildStatus()">
                        <div class="bg-green-500 w-4 h-4 rounded-full shadow-lg"></div>
                        <div class="bg-green-500 w-4 h-4 rounded-full absolute top-0 pulse-animation"></div>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div class="stat-card">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-route text-sm text-blue-600"></i>
                            <p class="text-xs text-blue-600 font-semibold">Distance</p>
                        </div>
                        <p class="text-xl font-bold text-blue-900">2.4<span class="text-sm text-blue-600"> mi</span></p>
                    </div>
                    
                    <div class="stat-card">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-clock text-sm text-yellow-600"></i>
                            <p class="text-xs text-yellow-600 font-semibold">ETA</p>
                        </div>
                        <p class="text-xl font-bold text-yellow-900" id="parent-eta">8<span class="text-sm text-yellow-600"> min</span></p>
                    </div>
                    
                    <div class="stat-card">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-temperature-high text-sm text-green-600"></i>
                            <p class="text-xs text-green-600 font-semibold">Temp</p>
                        </div>
                        <p class="text-xl font-bold text-green-900">72°<span class="text-sm text-green-600">F</span></p>
                    </div>
                </div>
                
                <!-- Journey Timeline -->
                <div class="bg-gray-50 rounded-2xl p-4 mb-6 border border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-gray-900">Today's Journey</h3>
                        <span class="text-xs text-gray-500" id="journey-status">On time</span>
                    </div>
                    
                    <div class="relative">
                        <!-- Timeline line -->
                        <div class="absolute left-6 top-0 bottom-0 w-0.5 bg-gradient-to-b from-blue-500 to-green-500"></div>
                        
                        <!-- Timeline items -->
                        <div class="space-y-6" id="timeline-items">
                            <!-- Timeline items will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="grid grid-cols-3 gap-3">
                    <button onclick="callDriver()" class="stat-card text-center hover:scale-105 transition-transform">
                        <i class="fas fa-phone-alt text-blue-600 text-lg mb-2"></i>
                        <p class="text-xs font-semibold text-gray-900">Call Driver</p>
                    </button>
                    
                    <button onclick="showNotifications()" class="stat-card text-center hover:scale-105 transition-transform">
                        <i class="fas fa-bell text-yellow-600 text-lg mb-2"></i>
                        <p class="text-xs font-semibold text-gray-900">Alerts</p>
                    </button>
                    
                    <button onclick="showHistory()" class="stat-card text-center hover:scale-105 transition-transform">
                        <i class="fas fa-history text-green-600 text-lg mb-2"></i>
                        <p class="text-xs font-semibold text-gray-900">History</p>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast hidden">
        <div class="flex items-center gap-3">
            <i id="toast-icon" class="fas fa-info-circle text-blue-500"></i>
            <div class="flex-1">
                <p class="font-semibold text-gray-900" id="toast-title">Notification</p>
                <p class="text-sm text-gray-600" id="toast-message"></p>
            </div>
            <button onclick="hideToast()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <p class="text-gray-700 font-medium" id="loading-text">Loading...</p>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="modal">
        <div class="modal-content animate__animated animate__fadeInUp">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-900">Reset Password</h3>
                <button onclick="hideForgotPassword()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="reset-email">Email Address</label>
                <input type="email" id="reset-email" class="form-input" placeholder="Enter your email">
            </div>
            
            <p class="text-sm text-gray-600 mb-6">
                We'll send you a link to reset your password.
            </p>
            
            <button onclick="sendResetLink()" class="btn-primary mb-4 hover:scale-[1.02] transition-transform">Send Reset Link</button>
            <button onclick="hideForgotPassword()" class="btn-secondary hover:scale-[1.02] transition-transform">Cancel</button>
        </div>
    </div>

    <!-- Sign Up Modal -->
    <div id="signup-modal" class="modal">
        <div class="modal-content animate__animated animate__fadeInUp">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-900">Create Account</h3>
                <button onclick="hideSignup()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="signup-form">
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <div class="flex gap-3">
                        <div class="role-option" onclick="selectSignupRole('driver')">
                            <i class="fas fa-tachometer-alt role-icon"></i>
                            <div class="font-semibold text-gray-800">Driver</div>
                        </div>
                        <div class="role-option" onclick="selectSignupRole('parent')">
                            <i class="fas fa-user-friends role-icon"></i>
                            <div class="font-semibold text-gray-800">Parent</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="signup-name">Full Name</label>
                    <input type="text" id="signup-name" class="form-input" placeholder="Enter your full name">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="signup-email">Email Address</label>
                    <input type="email" id="signup-email" class="form-input" placeholder="Enter your email">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="signup-password">Password</label>
                    <input type="password" id="signup-password" class="form-input" placeholder="Create a password">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="signup-confirm">Confirm Password</label>
                    <input type="password" id="signup-confirm" class="form-input" placeholder="Confirm password">
                </div>
                
                <div class="form-group">
                    <label class="flex items-center">
                        <input type="checkbox" id="terms" class="mr-2">
                        <span class="text-sm text-gray-600">I agree to the <a href="#" onclick="showTerms()" class="text-blue-600">Terms & Conditions</a></span>
                    </label>
                </div>
            </form>
            
            <button onclick="createAccount()" class="btn-primary mb-4 hover:scale-[1.02] transition-transform">Create Account</button>
            <button onclick="hideSignup()" class="btn-secondary hover:scale-[1.02] transition-transform">Cancel</button>
        </div>
    </div>

    <!-- User Menu Modal -->
    <div id="user-menu-modal" class="modal">
        <div class="modal-content animate__animated animate__fadeInUp">
            <div class="text-center mb-6">
                <img id="user-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=User" class="w-20 h-20 rounded-full mx-auto mb-4 border-4 border-white shadow-lg" alt="User">
                <h3 class="text-xl font-bold text-gray-900" id="user-name">John Driver</h3>
                <p class="text-gray-600 text-sm" id="user-role">Driver</p>
            </div>
            
            <div class="space-y-2">
                <button onclick="showProfile()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-100 transition-colors">
                    <i class="fas fa-user text-gray-600"></i>
                    <span class="font-medium text-gray-800">Profile</span>
                </button>
                
                <button onclick="showSettings()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-100 transition-colors">
                    <i class="fas fa-cog text-gray-600"></i>
                    <span class="font-medium text-gray-800">Settings</span>
                </button>
                
                <button onclick="showHelp()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-100 transition-colors">
                    <i class="fas fa-question-circle text-gray-600"></i>
                    <span class="font-medium text-gray-800">Help & Support</span>
                </button>
                
                <div class="border-t border-gray-200 my-3"></div>
                
                <button onclick="logout()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-red-50 text-red-600 transition-colors">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="font-medium">Log Out</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal">
        <div class="modal-content animate__animated animate__fadeInUp">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-900">My Profile</h3>
                <button onclick="hideProfile()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="text-center mb-6">
                <img id="profile-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=User" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-white shadow-lg" alt="User">
                <h4 class="text-lg font-bold text-gray-900" id="profile-name">John Driver</h4>
                <p class="text-gray-600 text-sm" id="profile-email">driver@demo.com</p>
            </div>
            
            <div class="space-y-4">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" id="profile-name-input" class="form-input" value="John Driver">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="profile-email-input" class="form-input" value="driver@demo.com" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" id="profile-phone" class="form-input" placeholder="+1 (555) 123-4567">
                </div>
            </div>
            
            <button onclick="updateProfile()" class="btn-primary mt-6 hover:scale-[1.02] transition-transform">Update Profile</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content animate__animated animate__fadeInUp">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-900">Settings</h3>
                <button onclick="hideSettings()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <div>
                    <h4 class="font-semibold text-gray-800 mb-3">Notifications</h4>
                    <div class="space-y-3">
                        <label class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <span class="text-gray-700">Push Notifications</span>
                            <div class="toggle-switch">
                                <input type="checkbox" id="push-notifications" checked>
                                <span class="toggle-slider"></span>
                            </div>
                        </label>
                        <label class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <span class="text-gray-700">Email Updates</span>
                            <div class="toggle-switch">
                                <input type="checkbox" id="email-updates" checked>
                                <span class="toggle-slider"></span>
                            </div>
                        </label>
                        <label class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <span class="text-gray-700">Sound Alerts</span>
                            <div class="toggle-switch">
                                <input type="checkbox" id="sound-alerts" checked>
                                <span class="toggle-slider"></span>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-semibold text-gray-800 mb-3">Map Preferences</h4>
                    <div class="space-y-3">
                        <label class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <span class="text-gray-700">Map Theme</span>
                            <select id="map-style" class="border-none bg-transparent text-gray-600 focus:outline-none">
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                                <option value="satellite">Satellite</option>
                            </select>
                        </label>
                        <label class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <span class="text-gray-700">Auto-refresh</span>
                            <select id="refresh-interval" class="border-none bg-transparent text-gray-600 focus:outline-none">
                                <option value="30">30 seconds</option>
                                <option value="60" selected>1 minute</option>
                                <option value="300">5 minutes</option>
                                <option value="0">Manual</option>
                            </select>
                        </label>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-semibold text-gray-800 mb-3">Data Management</h4>
                    <div class="space-y-3">
                        <button onclick="exportData()" class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 text-blue-600 font-medium">
                            <i class="fas fa-download mr-2"></i>Export All Data
                        </button>
                        <button onclick="showImportData()" class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 text-blue-600 font-medium">
                            <i class="fas fa-upload mr-2"></i>Import Data
                        </button>
                        <button onclick="clearAllData()" class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 text-red-600 font-medium">
                            <i class="fas fa-trash mr-2"></i>Clear All Data
                        </button>
                    </div>
                </div>
            </div>
            
            <button onclick="saveSettings()" class="btn-primary mt-6 hover:scale-[1.02] transition-transform">Save Settings</button>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal">
        <div class="modal-content animate__animated animate__fadeInUp">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-900">Help & Support</h3>
                <button onclick="hideHelp()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-semibold text-gray-800 mb-2"><i class="fas fa-info-circle text-blue-500 mr-2"></i>How to Use BusTrack</h4>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>• Drivers: Start/stop trips and track routes</li>
                        <li>• Parents: Monitor your child's bus in real-time</li>
                        <li>• Click on bus markers for details</li>
                        <li>• Use the bottom sheet for controls</li>
                    </ul>
                </div>
                
                <div class="p-4 bg-green-50 rounded-lg">
                    <h4 class="font-semibold text-gray-800 mb-2"><i class="fas fa-question-circle text-green-500 mr-2"></i>Frequently Asked Questions</h4>
                    <div class="space-y-3">
                        <details class="text-sm">
                            <summary class="font-medium text-gray-700 cursor-pointer">How accurate is the tracking?</summary>
                            <p class="text-gray-600 mt-1">Tracking updates every 30 seconds for real-time accuracy.</p>
                        </details>
                        <details class="text-sm">
                            <summary class="font-medium text-gray-700 cursor-pointer">Can I track multiple children?</summary>
                            <p class="text-gray-600 mt-1">Yes, you can add multiple children in your profile.</p>
                        </details>
                    </div>
                </div>
                
                <div class="p-4 bg-yellow-50 rounded-lg">
                    <h4 class="font-semibold text-gray-800 mb-2"><i class="fas fa-phone-alt text-yellow-500 mr-2"></i>Contact Support</h4>
                    <p class="text-sm text-gray-600">Email: support@bustrack.com</p>
                    <p class="text-sm text-gray-600">Phone: 1-800-BUS-TRACK</p>
                </div>
            </div>
            
            <button onclick="hideHelp()" class="btn-primary mt-6 hover:scale-[1.02] transition-transform">Close</button>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="modal">
        <div class="modal-content animate__animated animate__fadeInUp">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-900">Trip History</h3>
                <button onclick="hideHistory()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-3" id="history-list">
                <!-- History items will be populated here -->
            </div>
            
            <button onclick="clearHistory()" class="btn-secondary mt-6 hover:scale-[1.02] transition-transform">Clear History</button>
        </div>
    </div>

    <!-- Import Data Modal -->
    <div id="import-modal" class="modal">
        <div class="modal-content animate__animated animate__fadeInUp">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-900">Import Data</h3>
                <button onclick="hideImport()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Upload JSON File</label>
                <input type="file" id="import-file" class="form-input" accept=".json">
            </div>
            
            <p class="text-sm text-gray-600 mb-6">
                Upload a previously exported JSON file to restore your data.
            </p>
            
            <button onclick="importData()" class="btn-primary mb-4 hover:scale-[1.02] transition-transform">Import Data</button>
            <button onclick="hideImport()" class="btn-secondary hover:scale-[1.02] transition-transform">Cancel</button>
        </div>
    </div>

    <!-- Terms Modal -->
    <div id="terms-modal" class="modal">
        <div class="modal-content animate__animated animate__fadeInUp">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-900">Terms & Conditions</h3>
                <button onclick="hideTerms()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="prose max-h-96 overflow-y-auto">
                <p class="text-sm text-gray-600 mb-4">
                    By using BusTrack, you agree to our terms and conditions...
                </p>
                <!-- Add full terms content here -->
            </div>
            
            <button onclick="hideTerms()" class="btn-primary mt-6 hover:scale-[1.02] transition-transform">I Agree</button>
        </div>
    </div>

    <!-- Floating Action Buttons -->
    <div id="fab-container" class="hidden absolute bottom-24 right-4 z-40 space-y-3">
        <button onclick="locateBus()" class="w-14 h-14 glass-nav rounded-2xl shadow-xl border border-white/30 flex items-center justify-center hover:scale-110 transition-transform">
            <i class="fas fa-location-arrow text-gray-700"></i>
        </button>
    </div>

    <script>
        // ==================== APPLICATION STATE ====================
        let map;
        let busMarker;
        let stopMarkers = [];
        let routeLine;
        let currentUser = null;
        let currentRole = null;
        let selectedRole = null;
        let signupRole = null;
        let isDriving = false;
        let currentTrip = null;
        let routeStops = [];
        let currentStopIndex = 0;
        let busLatLng = [40.7128, -74.006];
        let refreshTimer = null;
        let tripSimulation = null;
        let etaTimer = null;

        // ==================== LOCAL STORAGE MANAGER ====================
        const StorageManager = {
            // Initialize demo data
            initDemoData() {
                // Demo users
                const demoUsers = {
                    'driver@demo.com': {
                        id: 'driver_001',
                        email: 'driver@demo.com',
                        password: 'driver123',
                        name: 'Mike Johnson',
                        role: 'driver',
                        phone: '+1 (555) 123-4567',
                        route: 'Route #402',
                        busNumber: 'BUS-402',
                        avatarSeed: 'MikeDriver',
                        createdAt: new Date().toISOString()
                    },
                    'parent@demo.com': {
                        id: 'parent_001',
                        email: 'parent@demo.com',
                        password: 'parent123',
                        name: 'Sarah Miller',
                        role: 'parent',
                        phone: '+1 (555) 987-6543',
                        children: [{
                            id: 'child_001',
                            name: 'Leo Miller',
                            grade: '3rd Grade',
                            school: 'Lincoln Elementary',
                            avatarSeed: 'LeoMiller',
                            busNumber: 'BUS-402'
                        }],
                        avatarSeed: 'SarahParent',
                        createdAt: new Date().toISOString()
                    }
                };

                // Demo route
                const demoRoute = {
                    'BUS-402': {
                        id: 'route_402',
                        number: '402',
                        name: 'Downtown Academy Express',
                        driver: 'Mike Johnson',
                        totalSeats: 30,
                        stops: [
                            { id: 1, name: "7th Avenue", lat: 40.713, lng: -74.008, order: 1, students: 12 },
                            { id: 2, name: "Oak Street", lat: 40.714, lng: -74.004, order: 2, students: 5 },
                            { id: 3, name: "Maple Drive", lat: 40.716, lng: -74.002, order: 3, students: 7 },
                            { id: 4, name: "Pine Road", lat: 40.717, lng: -74.000, order: 4, students: 3 },
                            { id: 5, name: "Lincoln Elementary", lat: 40.718, lng: -73.998, order: 5, students: 0 }
                        ]
                    }
                };

                // Initialize localStorage if empty
                if (!localStorage.getItem('busTrack_users')) {
                    localStorage.setItem('busTrack_users', JSON.stringify(demoUsers));
                }

                if (!localStorage.getItem('busTrack_routes')) {
                    localStorage.setItem('busTrack_routes', JSON.stringify(demoRoute));
                }

                if (!localStorage.getItem('busTrack_trips')) {
                    localStorage.setItem('busTrack_trips', JSON.stringify([]));
                }

                if (!localStorage.getItem('busTrack_notifications')) {
                    const demoNotifications = [
                        {
                            id: 1,
                            type: 'info',
                            title: 'Welcome to BusTrack!',
                            message: 'Your account has been created successfully.',
                            timestamp: new Date().toISOString(),
                            read: true
                        },
                        {
                            id: 2,
                            type: 'success',
                            title: 'Bus On Time',
                            message: 'Bus 402 is running on schedule today.',
                            timestamp: new Date().toISOString(),
                            read: false
                        }
                    ];
                    localStorage.setItem('busTrack_notifications', JSON.stringify(demoNotifications));
                }

                if (!localStorage.getItem('busTrack_settings')) {
                    const defaultSettings = {
                        pushNotifications: true,
                        emailUpdates: true,
                        soundAlerts: true,
                        mapStyle: 'light',
                        refreshInterval: 60,
                        theme: 'blue'
                    };
                    localStorage.setItem('busTrack_settings', JSON.stringify(defaultSettings));
                }
            },

            // User management
            getUser(email) {
                const users = JSON.parse(localStorage.getItem('busTrack_users') || '{}');
                return users[email];
            },

            saveUser(user) {
                const users = JSON.parse(localStorage.getItem('busTrack_users') || '{}');
                users[user.email] = user;
                localStorage.setItem('busTrack_users', JSON.stringify(users));
            },

            // Session management
            saveSession(user) {
                const session = {
                    userId: user.id,
                    email: user.email,
                    role: user.role,
                    name: user.name,
                    loginTime: new Date().toISOString()
                };
                localStorage.setItem('busTrack_session', JSON.stringify(session));
            },

            getSession() {
                return JSON.parse(localStorage.getItem('busTrack_session'));
            },

            clearSession() {
                localStorage.removeItem('busTrack_session');
            },

            // Trip management
            getTrips(limit = 10) {
                const trips = JSON.parse(localStorage.getItem('busTrack_trips') || '[]');
                return trips.slice(0, limit);
            },

            saveTrip(trip) {
                const trips = JSON.parse(localStorage.getItem('busTrack_trips') || '[]');
                trip.id = 'trip_' + Date.now();
                trip.timestamp = new Date().toISOString();
                trips.unshift(trip);
                localStorage.setItem('busTrack_trips', JSON.stringify(trips.slice(0, 50))); // Keep last 50 trips
            },

            clearTrips() {
                localStorage.setItem('busTrack_trips', JSON.stringify([]));
            },

            // Route management
            getRoute(busNumber) {
                const routes = JSON.parse(localStorage.getItem('busTrack_routes') || '{}');
                return routes[busNumber];
            },

            // Notification management
            getNotifications() {
                return JSON.parse(localStorage.getItem('busTrack_notifications') || '[]');
            },

            addNotification(notification) {
                const notifications = this.getNotifications();
                notification.id = 'notif_' + Date.now();
                notification.timestamp = new Date().toISOString();
                notification.read = false;
                notifications.unshift(notification);
                localStorage.setItem('busTrack_notifications', JSON.stringify(notifications.slice(0, 100)));
            },

            markAllAsRead() {
                const notifications = this.getNotifications();
                notifications.forEach(notif => notif.read = true);
                localStorage.setItem('busTrack_notifications', JSON.stringify(notifications));
            },

            clearNotifications() {
                localStorage.setItem('busTrack_notifications', JSON.stringify([]));
            },

            // Settings management
            getSettings() {
                return JSON.parse(localStorage.getItem('busTrack_settings') || '{}');
            },

            saveSettings(settings) {
                localStorage.setItem('busTrack_settings', JSON.stringify(settings));
            },

            // Data export/import
            exportData() {
                const data = {
                    users: JSON.parse(localStorage.getItem('busTrack_users') || '{}'),
                    routes: JSON.parse(localStorage.getItem('busTrack_routes') || '{}'),
                    trips: JSON.parse(localStorage.getItem('busTrack_trips') || '[]'),
                    notifications: JSON.parse(localStorage.getItem('busTrack_notifications') || '[]'),
                    settings: JSON.parse(localStorage.getItem('busTrack_settings') || '{}'),
                    exportDate: new Date().toISOString()
                };
                return JSON.stringify(data, null, 2);
            },

            importData(jsonData) {
                try {
                    const data = JSON.parse(jsonData);
                    
                    if (data.users) localStorage.setItem('busTrack_users', JSON.stringify(data.users));
                    if (data.routes) localStorage.setItem('busTrack_routes', JSON.stringify(data.routes));
                    if (data.trips) localStorage.setItem('busTrack_trips', JSON.stringify(data.trips));
                    if (data.notifications) localStorage.setItem('busTrack_notifications', JSON.stringify(data.notifications));
                    if (data.settings) localStorage.setItem('busTrack_settings', JSON.stringify(data.settings));
                    
                    return true;
                } catch (error) {
                    console.error('Import failed:', error);
                    return false;
                }
            },

            // Clear all data (reset to demo)
            clearAllData() {
                const keys = [
                    'busTrack_users',
                    'busTrack_routes',
                    'busTrack_trips',
                    'busTrack_notifications',
                    'busTrack_settings',
                    'busTrack_session'
                ];
                
                keys.forEach(key => localStorage.removeItem(key));
                this.initDemoData();
                return true;
            }
        };

        // ==================== INITIALIZATION ====================
        window.addEventListener('DOMContentLoaded', () => {
            // Initialize storage with demo data
            StorageManager.initDemoData();
            
            // Check for existing session
            const session = StorageManager.getSession();
            if (session) {
                const user = StorageManager.getUser(session.email);
                if (user) {
                    currentUser = user;
                    currentRole = user.role;
                    initApp();
                    return;
                }
            }
            
            // Show loading animation
            simulateLoading();
        });

        function simulateLoading() {
            let progress = 0;
            const loadingBar = document.getElementById('loading-bar');
            const interval = setInterval(() => {
                progress += 2;
                loadingBar.style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('loading-screen').classList.add('hidden');
                        document.getElementById('login-screen').classList.remove('hidden');
                        // Pre-fill demo credentials
                        document.getElementById('email').value = 'driver@demo.com';
                        document.getElementById('password').value = 'driver123';
                        selectRole('driver');
                    }, 500);
                }
            }, 30);
        }

        // ==================== AUTHENTICATION ====================
        function selectRole(role) {
            selectedRole = role;
            document.querySelectorAll('.role-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.closest('.role-option').classList.add('selected');
        }

        function selectSignupRole(role) {
            signupRole = role;
            document.querySelectorAll('#signup-modal .role-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.closest('.role-option').classList.add('selected');
        }

        function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            
            if (!email || !password) {
                showToast('Error', 'Please fill in all fields', 'error');
                return;
            }
            
            if (!selectedRole) {
                showToast('Error', 'Please select a role', 'error');
                return;
            }
            
            const user = StorageManager.getUser(email);
            
            if (user && user.password === password && user.role === selectedRole) {
                currentUser = user;
                currentRole = user.role;
                
                // Save session
                StorageManager.saveSession(user);
                
                // Hide login and show app
                document.getElementById('login-screen').classList.add('hidden');
                initApp();
                
                showToast('Welcome Back', `Hello, ${user.name}!`, 'success');
            } else {
                showToast('Login Failed', 'Invalid email or password', 'error');
            }
        }

        function createAccount() {
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const confirm = document.getElementById('signup-confirm').value;
            const terms = document.getElementById('terms').checked;
            
            if (!name || !email || !password || !confirm) {
                showToast('Error', 'Please fill in all fields', 'error');
                return;
            }
            
            if (!signupRole) {
                showToast('Error', 'Please select a role', 'error');
                return;
            }
            
            if (password !== confirm) {
                showToast('Error', 'Passwords do not match', 'error');
                return;
            }
            
            if (!terms) {
                showToast('Error', 'Please accept the terms and conditions', 'error');
                return;
            }
            
            // Check if user exists
            if (StorageManager.getUser(email)) {
                showToast('Error', 'User with this email already exists', 'error');
                return;
            }
            
            // Create new user
            const newUser = {
                id: 'user_' + Date.now(),
                email: email,
                password: password,
                name: name,
                role: signupRole,
                avatarSeed: name.replace(/\s+/g, ''),
                createdAt: new Date().toISOString()
            };
            
            // Add role-specific data
            if (signupRole === 'driver') {
                newUser.route = 'New Route';
                newUser.busNumber = 'BUS-' + (Math.floor(Math.random() * 900) + 100);
            } else {
                newUser.children = [];
            }
            
            // Save user
            StorageManager.saveUser(newUser);
            StorageManager.saveSession(newUser);
            
            // Set current user
            currentUser = newUser;
            currentRole = signupRole;
            
            // Close modal and init app
            hideSignup();
            document.getElementById('login-screen').classList.add('hidden');
            initApp();
            
            showToast('Welcome!', `Account created for ${name}`, 'success');
            
            // Add welcome notification
            StorageManager.addNotification({
                type: 'success',
                title: 'Welcome to BusTrack!',
                message: 'Your account has been created successfully.'
            });
        }

        // ==================== APP INITIALIZATION ====================
        function initApp() {
            // Show UI elements
            document.getElementById('top-nav').classList.remove('hidden');
            document.getElementById('fab-container').classList.remove('hidden');
            document.getElementById('bottom-sheet').classList.remove('hidden');
            
            // Update user info
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = currentRole === 'driver' ? 'Driver' : 'Parent';
            document.getElementById('user-avatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUser.avatarSeed}`;
            document.getElementById('profile-avatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUser.avatarSeed}`;
            document.getElementById('profile-name').textContent = currentUser.name;
            document.getElementById('profile-email').textContent = currentUser.email;
            document.getElementById('profile-name-input').value = currentUser.name;
            document.getElementById('profile-email-input').value = currentUser.email;
            document.getElementById('profile-phone').value = currentUser.phone || '';
            
            // Load settings
            loadSettings();
            
            // Initialize map
            initMap();
            
            // Show role-specific UI
            if (currentRole === 'driver') {
                showDriverUI();
            } else {
                showParentUI();
            }
            
            // Expand bottom sheet
            setTimeout(() => {
                expandBottomSheet();
            }, 300);
            
            // Start background tasks
            startBackgroundTasks();
        }

        function loadSettings() {
            const settings = StorageManager.getSettings();
            
            // Apply settings to UI
            document.getElementById('push-notifications').checked = settings.pushNotifications !== false;
            document.getElementById('email-updates').checked = settings.emailUpdates !== false;
            document.getElementById('sound-alerts').checked = settings.soundAlerts !== false;
            document.getElementById('map-style').value = settings.mapStyle || 'light';
            document.getElementById('refresh-interval').value = settings.refreshInterval || 60;
            
            // Start refresh timer
            startRefreshTimer(settings.refreshInterval || 60);
        }

        function startRefreshTimer(interval) {
            if (refreshTimer) clearInterval(refreshTimer);
            if (interval > 0) {
                refreshTimer = setInterval(refreshData, interval * 1000);
            }
        }

        // ==================== MAP FUNCTIONS ====================
        function initMap() {
            // Create map
            map = L.map('map', {
                center: busLatLng,
                zoom: 15,
                zoomControl: false,
                attributionControl: false
            });

            // Add tile layer based on settings
            const settings = StorageManager.getSettings();
            const style = settings.mapStyle || 'light';
            
            let tileUrl;
            switch(style) {
                case 'dark':
                    tileUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
                    break;
                case 'satellite':
                    tileUrl = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
                    break;
                default:
                    tileUrl = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
            }

            L.tileLayer(tileUrl, {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Add zoom control
            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);

            // Create bus marker
            const busIcon = L.divIcon({
                html: `
                    <div class="bus-marker">
                        <div class="relative">
                            <div class="absolute inset-0 bg-blue-400 rounded-full blur-xl opacity-50"></div>
                            <div class="relative bg-white p-3 rounded-full shadow-2xl border-4 border-blue-500">
                                <i class="fas fa-bus text-lg text-blue-500"></i>
                            </div>
                        </div>
                    </div>
                `,
                className: '',
                iconSize: [48, 48],
                iconAnchor: [24, 24]
            });

            busMarker = L.marker(busLatLng, { icon: busIcon }).addTo(map);

            // Load and draw route
            loadRoute();
        }

        function loadRoute() {
            // Clear existing stops and route
            stopMarkers.forEach(marker => map.removeLayer(marker));
            stopMarkers = [];
            if (routeLine) map.removeLayer(routeLine);

            // Get route based on role
            let route;
            if (currentRole === 'driver') {
                route = StorageManager.getRoute(currentUser.busNumber);
            } else if (currentUser.children && currentUser.children[0]) {
                route = StorageManager.getRoute(currentUser.children[0].busNumber);
            }

            if (route) {
                routeStops = route.stops || [];
                
                // Create route line
                const routeCoords = routeStops.map(stop => [stop.lat, stop.lng]);
                routeLine = L.polyline(routeCoords, {
                    color: '#3B82F6',
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '10, 10'
                }).addTo(map);

                // Create stop markers
                routeStops.forEach((stop, index) => {
                    const stopIcon = L.divIcon({
                        html: `
                            <div class="stop-marker ${index <= currentStopIndex ? 'completed' : ''}" 
                                 style="background: ${index <= currentStopIndex ? '#10B981' : 'white'}; 
                                        border-color: ${index <= currentStopIndex ? '#10B981' : '#3B82F6'};
                                        color: ${index <= currentStopIndex ? 'white' : '#3B82F6'}">
                                ${index + 1}
                            </div>
                        `,
                        className: '',
                        iconSize: [28, 28],
                        iconAnchor: [14, 14]
                    });

                    const marker = L.marker([stop.lat, stop.lng], { icon: stopIcon }).addTo(map);
                    marker.bindPopup(`
                        <div class="p-2">
                            <strong class="text-sm">${stop.name}</strong><br>
                            <span class="text-xs text-gray-600">Stop ${index + 1}</span><br>
                            <span class="text-xs text-gray-600">${stop.students} students</span>
                        </div>
                    `);
                    stopMarkers.push(marker);
                });

                // Fit map to route
                const bounds = L.latLngBounds(routeCoords);
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        // ==================== DRIVER UI FUNCTIONS ====================
        function showDriverUI() {
            document.getElementById('driver-status').classList.remove('hidden');
            document.getElementById('driver-ui').classList.remove('hidden');
            document.getElementById('parent-ui').classList.add('hidden');
            document.getElementById('parent-status').classList.add('hidden');

            // Load driver data
            const route = StorageManager.getRoute(currentUser.busNumber);
            if (route) {
                document.getElementById('driver-route-name').textContent = `Route #${route.number}`;
                document.getElementById('driver-destination').textContent = route.name;
                document.getElementById('route-number').textContent = `Route #${route.number}`;
                document.getElementById('route-name').textContent = route.name;
                
                // Update stops list
                updateRouteStopsList();
            }

            // Start clock
            updateTime();
            setInterval(updateTime, 1000);
        }

        function updateRouteStopsList() {
            const container = document.getElementById('route-stops-list');
            container.innerHTML = '';

            routeStops.forEach((stop, index) => {
                const status = index < currentStopIndex ? 'completed' : 
                              index === currentStopIndex ? 'current' : 'upcoming';
                
                const stopEl = document.createElement('div');
                stopEl.className = 'flex items-center gap-3';
                stopEl.innerHTML = `
                    <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs
                        ${status === 'completed' ? 'bg-green-500' : 
                          status === 'current' ? 'bg-yellow-400 bounce-animation' : 'bg-gray-300'}">
                        ${status === 'completed' ? '<i class="fas fa-check"></i>' : 
                          status === 'current' ? '<i class="fas fa-arrow-right"></i>' : index + 1}
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between">
                            <span class="${status === 'current' ? 'font-bold text-gray-900' : 'text-gray-700'}">
                                ${stop.name}
                            </span>
                            <span class="text-xs ${status === 'completed' ? 'text-gray-500' : 'text-gray-600'}">
                                Stop ${index + 1}
                            </span>
                        </div>
                        ${stop.students > 0 ? 
                            `<p class="text-xs text-gray-500">${stop.students} students</p>` : ''}
                    </div>
                `;
                container.appendChild(stopEl);
            });
        }

        // ==================== PARENT UI FUNCTIONS ====================
        function showParentUI() {
            document.getElementById('parent-status').classList.remove('hidden');
            document.getElementById('parent-ui').classList.remove('hidden');
            document.getElementById('driver-ui').classList.add('hidden');
            document.getElementById('driver-status').classList.add('hidden');

            // Load parent data
            if (currentUser.children && currentUser.children[0]) {
                const child = currentUser.children[0];
                document.getElementById('child-name').textContent = `${child.name}'s Journey`;
                document.getElementById('bus-info').textContent = `Bus ${child.busNumber} • Driver: Mike`;
                document.getElementById('child-avatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${child.avatarSeed}`;
                
                // Update timeline
                updateTimeline();
            }

            // Start ETA updates
            startEtaUpdates();
        }

        function updateTimeline() {
            const container = document.getElementById('timeline-items');
            container.innerHTML = '';

            const timelineData = [
                { time: '07:45 AM', title: 'Pickup', desc: '7th Avenue Crossroads', icon: 'map-marker-alt', color: 'blue', status: 'completed' },
                { time: '07:52 AM', title: 'Current Location', desc: 'Approaching Oak Street', icon: 'location-arrow', color: 'yellow', status: 'current' },
                { time: '08:20 AM', title: 'School Arrival', desc: 'Lincoln Elementary', icon: 'school', color: 'green', status: 'upcoming' }
            ];

            timelineData.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex items-center gap-4 relative';
                itemEl.innerHTML = `
                    <div class="w-12 h-12 bg-${item.color}-500 rounded-xl shadow-lg flex items-center justify-center z-10">
                        <i class="fas fa-${item.icon} text-white"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-bold text-gray-900">${item.title}</p>
                        <p class="text-sm text-gray-600">${item.desc}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-gray-900">${item.time.split(' ')[0]}</p>
                        <p class="text-xs text-gray-500">${item.time.split(' ')[1]}</p>
                    </div>
                `;
                container.appendChild(itemEl);
            });
        }

        function startEtaUpdates() {
            if (etaTimer) clearInterval(etaTimer);
            
            etaTimer = setInterval(() => {
                if (isDriving) {
                    const etaEl = document.getElementById('eta-time');
                    const parentEta = document.getElementById('parent-eta');
                    let currentEta = parseInt(etaEl.textContent) || 8;
                    
                    if (currentEta > 0) {
                        currentEta--;
                        etaEl.textContent = currentEta;
                        parentEta.innerHTML = `${currentEta}<span class="text-sm text-yellow-600"> min</span>`;
                        
                        // Update progress
                        const progress = 100 - (currentEta / 8 * 100);
                        document.getElementById('route-progress').style.width = `${progress}%`;
                    }
                }
            }, 60000); // Update every minute
        }

        // ==================== TRIP MANAGEMENT ====================
        function toggleTrip() {
            if (!isDriving) {
                startTrip();
            } else {
                endTrip();
            }
        }

        function startTrip() {
            isDriving = true;
            currentStopIndex = 0;

            // Update UI
            document.getElementById('toggle-trip').innerHTML = '<i class="fas fa-stop mr-2"></i><span>End Trip</span>';
            document.getElementById('driver-status-badge').innerHTML = '<i class="fas fa-circle text-xs mr-1 text-green-500"></i>Live';
            document.getElementById('driver-status-badge').className = 'bg-green-100 text-green-600 px-3 py-1 rounded-full text-xs font-bold uppercase';

            // Create trip record
            currentTrip = {
                userId: currentUser.id,
                role: 'driver',
                busNumber: currentUser.busNumber,
                startTime: new Date().toISOString(),
                status: 'active',
                stops: routeStops.map(stop => ({ ...stop, visited: false }))
            };

            // Save trip
            StorageManager.saveTrip(currentTrip);

            // Start simulation
            simulateTrip();

            showToast('Trip Started', 'Route tracking has begun', 'success');

            // Notify parents
            if (currentRole === 'driver') {
                StorageManager.addNotification({
                    type: 'info',
                    title: 'Bus Departure',
                    message: `Bus ${currentUser.busNumber} has started its route.`
                });
            }
        }

        function endTrip() {
            isDriving = false;

            // Update UI
            document.getElementById('toggle-trip').innerHTML = '<i class="fas fa-play mr-2"></i><span>Start Trip</span>';
            document.getElementById('driver-status-badge').innerHTML = '<i class="fas fa-circle text-xs mr-1"></i>Offline';
            document.getElementById('driver-status-badge').className = 'bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold uppercase';

            // Stop simulation
            if (tripSimulation) {
                clearTimeout(tripSimulation);
                tripSimulation = null;
            }

            // Update trip record
            if (currentTrip) {
                currentTrip.endTime = new Date().toISOString();
                currentTrip.status = 'completed';
                currentTrip.distance = 12.5;
                currentTrip.onTime = true;
                StorageManager.saveTrip(currentTrip);
            }

            showToast('Trip Ended', 'Route tracking stopped', 'info');
        }

        function simulateTrip() {
            if (!isDriving) return;

            // Move to next stop
            currentStopIndex = (currentStopIndex + 1) % routeStops.length;
            const nextStop = routeStops[currentStopIndex];

            // Update bus position
            busLatLng = [nextStop.lat, nextStop.lng];
            busMarker.setLatLng(busLatLng);

            // Update UI
            document.getElementById('driver-next-stop').textContent = nextStop.name;
            document.getElementById('next-stop-name').textContent = nextStop.name;
            document.getElementById('next-stop-eta').textContent = 'Arriving now';

            // Update progress
            const progress = ((currentStopIndex + 1) / routeStops.length) * 100;
            document.getElementById('route-progress').style.width = `${progress}%`;

            // Update route display
            updateRouteStopsList();
            updateStopMarkers();

            // Center map
            map.setView(busLatLng, 16);

            // Show notification
            if (currentStopIndex < routeStops.length - 1) {
                showToast('Next Stop', `Arriving at ${nextStop.name}`, 'info');
                
                // Notify parents
                StorageManager.addNotification({
                    type: 'info',
                    title: 'Bus Update',
                    message: `Bus ${currentUser.busNumber} is arriving at ${nextStop.name}.`
                });
            }

            // Continue simulation
            if (isDriving) {
                tripSimulation = setTimeout(simulateTrip, 5000);
            }
        }

        function updateStopMarkers() {
            stopMarkers.forEach((marker, index) => {
                const stop = routeStops[index];
                const isCompleted = index <= currentStopIndex;
                
                const icon = L.divIcon({
                    html: `
                        <div class="stop-marker ${isCompleted ? 'completed' : ''}" 
                             style="background: ${isCompleted ? '#10B981' : 'white'}; 
                                    border-color: ${isCompleted ? '#10B981' : '#3B82F6'};
                                    color: ${isCompleted ? 'white' : '#3B82F6'}">
                            ${index + 1}
                        </div>
                    `,
                    className: '',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                });
                
                marker.setIcon(icon);
            });
        }

        // ==================== UTILITY FUNCTIONS ====================
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
            document.getElementById('current-time').textContent = timeStr;
        }

        function showToast(title, message, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            
            switch(type) {
                case 'success':
                    icon.className = 'fas fa-check-circle text-green-500';
                    break;
                case 'error':
                    icon.className = 'fas fa-exclamation-circle text-red-500';
                    break;
                case 'warning':
                    icon.className = 'fas fa-exclamation-triangle text-yellow-500';
                    break;
                default:
                    icon.className = 'fas fa-info-circle text-blue-500';
            }
            
            document.getElementById('toast-title').textContent = title;
            document.getElementById('toast-message').textContent = message;
            
            toast.classList.remove('hidden');
            
            // Auto-hide after 4 seconds
            setTimeout(hideToast, 4000);
        }

        function hideToast() {
            document.getElementById('toast').classList.add('hidden');
        }

        function showLoading(text) {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // ==================== MODAL FUNCTIONS ====================
        // Show modals
        function showForgotPassword() {
            document.getElementById('forgot-password-modal').style.display = 'flex';
        }

        function showSignup() {
            document.getElementById('signup-modal').style.display = 'flex';
        }

        function showUserMenu() {
            document.getElementById('user-menu-modal').style.display = 'flex';
        }

        function showProfile() {
            document.getElementById('user-menu-modal').style.display = 'none';
            document.getElementById('profile-modal').style.display = 'flex';
        }

        function showSettings() {
            document.getElementById('user-menu-modal').style.display = 'none';
            document.getElementById('settings-modal').style.display = 'flex';
        }

        function showHelp() {
            document.getElementById('user-menu-modal').style.display = 'none';
            document.getElementById('help-modal').style.display = 'flex';
        }

        function showHistory() {
            loadHistory();
            document.getElementById('history-modal').style.display = 'flex';
        }

        function showTerms() {
            document.getElementById('terms-modal').style.display = 'flex';
        }

        function showImportData() {
            document.getElementById('import-modal').style.display = 'flex';
        }

        // Hide modals
        function hideForgotPassword() {
            document.getElementById('forgot-password-modal').style.display = 'none';
        }

        function hideSignup() {
            document.getElementById('signup-modal').style.display = 'none';
        }

        function hideProfile() {
            document.getElementById('profile-modal').style.display = 'none';
        }

        function hideSettings() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        function hideHelp() {
            document.getElementById('help-modal').style.display = 'none';
        }

        function hideHistory() {
            document.getElementById('history-modal').style.display = 'none';
        }

        function hideTerms() {
            document.getElementById('terms-modal').style.display = 'none';
        }

        function hideImport() {
            document.getElementById('import-modal').style.display = 'none';
        }

        // ==================== BUTTON FUNCTIONS ====================
        function sendResetLink() {
            const email = document.getElementById('reset-email').value;
            if (!email) {
                showToast('Error', 'Please enter your email', 'error');
                return;
            }
            
            showToast('Reset Link Sent', 'Check your email for instructions', 'success');
            hideForgotPassword();
        }

        function updateProfile() {
            const name = document.getElementById('profile-name-input').value;
            const phone = document.getElementById('profile-phone').value;
            
            if (!name) {
                showToast('Error', 'Name is required', 'error');
                return;
            }
            
            // Update user in storage
            const users = JSON.parse(localStorage.getItem('busTrack_users') || '{}');
            if (users[currentUser.email]) {
                users[currentUser.email].name = name;
                users[currentUser.email].phone = phone;
                localStorage.setItem('busTrack_users', JSON.stringify(users));
                
                // Update current user
                currentUser.name = name;
                currentUser.phone = phone;
                
                // Update UI
                document.getElementById('user-name').textContent = name;
                document.getElementById('profile-name').textContent = name;
                
                showToast('Profile Updated', 'Your profile has been updated', 'success');
                hideProfile();
            }
        }

        function saveSettings() {
            const settings = {
                pushNotifications: document.getElementById('push-notifications').checked,
                emailUpdates: document.getElementById('email-updates').checked,
                soundAlerts: document.getElementById('sound-alerts').checked,
                mapStyle: document.getElementById('map-style').value,
                refreshInterval: parseInt(document.getElementById('refresh-interval').value),
                theme: 'blue'
            };
            
            StorageManager.saveSettings(settings);
            
            // Restart refresh timer
            startRefreshTimer(settings.refreshInterval);
            
            // Update map style if changed
            if (map) {
                const tileUrl = getTileUrl(settings.mapStyle);
                map.eachLayer(layer => {
                    if (layer instanceof L.TileLayer) {
                        map.removeLayer(layer);
                    }
                });
                
                L.tileLayer(tileUrl, {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);
                
                // Re-add other layers
                if (busMarker) busMarker.addTo(map);
                if (routeLine) routeLine.addTo(map);
                stopMarkers.forEach(marker => marker.addTo(map));
            }
            
            showToast('Settings Saved', 'Your preferences have been updated', 'success');
            hideSettings();
        }

        function getTileUrl(style) {
            switch(style) {
                case 'dark':
                    return 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
                case 'satellite':
                    return 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
                default:
                    return 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
            }
        }

        function exportData() {
            const data = StorageManager.exportData();
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bustrack-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Data Exported', 'Your data has been downloaded', 'success');
        }

        function importData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('Error', 'Please select a file', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const success = StorageManager.importData(e.target.result);
                if (success) {
                    showToast('Data Imported', 'Your data has been restored', 'success');
                    hideImport();
                    // Refresh the page to apply changes
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast('Error', 'Failed to import data. Invalid file format.', 'error');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                StorageManager.clearAllData();
                showToast('Data Cleared', 'All data has been reset', 'success');
                setTimeout(() => location.reload(), 1500);
            }
        }

        function loadHistory() {
            const trips = StorageManager.getTrips(10);
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            
            if (trips.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No trip history found</p>';
                return;
            }
            
            trips.forEach(trip => {
                const date = new Date(trip.timestamp);
                const item = document.createElement('div');
                item.className = 'p-3 border border-gray-200 rounded-lg hover:bg-gray-50';
                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-medium">${trip.busNumber}</span>
                        <span class="text-sm text-gray-500">${date.toLocaleDateString()}</span>
                    </div>
                    <div class="text-sm text-gray-600 mt-1">
                        ${trip.status === 'completed' ? 'Completed' : 'In Progress'} • 
                        ${trip.distance ? trip.distance + ' mi' : 'Distance N/A'}
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all trip history?')) {
                StorageManager.clearTrips();
                loadHistory();
                showToast('History Cleared', 'All trip history has been removed', 'success');
            }
        }

        function callDriver() {
            showToast('Calling Driver', 'Connecting to Mike...', 'info');
            // In a real app, this would initiate a phone call
            // Simulate call with delay
            setTimeout(() => {
                showToast('Call Connected', 'You are now connected to the driver', 'success');
            }, 2000);
        }

        function showNotifications() {
            const notifications = StorageManager.getNotifications();
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                StorageManager.markAllAsRead();
                showToast('Notifications', `You had ${unreadCount} unread notification${unreadCount > 1 ? 's' : ''}`, 'info');
            } else {
                showToast('Notifications', 'No new notifications', 'info');
            }
        }

        function refreshData() {
            showToast('Refreshing', 'Updating data...', 'info');
            
            // Simulate data refresh
            setTimeout(() => {
                if (currentRole === 'driver') {
                    updateRouteStopsList();
                } else {
                    updateTimeline();
                }
                showToast('Updated', 'Data refreshed successfully', 'success');
            }, 1000);
        }

        function locateBus() {
            if (map && busMarker) {
                map.setView(busMarker.getLatLng(), 16);
                showToast('Location', 'Centered on bus position', 'info');
            }
        }

        function toggleBottomSheet() {
            const sheet = document.getElementById('bottom-sheet');
            const transform = sheet.style.transform;
            
            if (transform.includes('0px')) {
                collapseBottomSheet();
            } else {
                expandBottomSheet();
            }
        }

        function expandBottomSheet() {
            document.getElementById('bottom-sheet').style.transform = 'translateY(0)';
        }

        function collapseBottomSheet() {
            document.getElementById('bottom-sheet').style.transform = 'translateY(calc(100% - 60px))';
        }

        function toggleChildStatus() {
            showToast('Child Status', 'Status updated to present', 'success');
        }

        function showStudentList() {
            showToast('Student Roster', 'Showing student list (24 students on board)', 'info');
        }

        function showNextStopDetails() {
            showToast('Next Stop', 'Oak Street - 5 students expected', 'info');
        }

        function showSchedule() {
            showToast('Schedule', 'Showing route schedule', 'info');
        }

        function showFullRoute() {
            showToast('Full Route', 'Showing complete route map', 'info');
        }

        function startBackgroundTasks() {
            // Check for notifications every 30 seconds
            setInterval(() => {
                if (isDriving && currentRole === 'driver') {
                    // Simulate random events
                    if (Math.random() > 0.7) {
                        const events = [
                            'Traffic delay ahead',
                            'Student pickup completed',
                            'Weather update: Clear skies',
                            'Schedule running on time'
                        ];
                        const randomEvent = events[Math.floor(Math.random() * events.length)];
                        
                        StorageManager.addNotification({
                            type: 'info',
                            title: 'Bus Update',
                            message: randomEvent
                        });
                    }
                }
            }, 30000);
        }

        function logout() {
            // Clear session
            StorageManager.clearSession();
            
            // Clear intervals
            if (refreshTimer) clearInterval(refreshTimer);
            if (etaTimer) clearInterval(etaTimer);
            if (tripSimulation) clearTimeout(tripSimulation);
            
            // Reset state
            currentUser = null;
            currentRole = null;
            isDriving = false;
            
            // Hide app UI
            document.getElementById('top-nav').classList.add('hidden');
            document.getElementById('fab-container').classList.add('hidden');
            document.getElementById('bottom-sheet').classList.add('hidden');
            document.getElementById('driver-ui').classList.add('hidden');
            document.getElementById('parent-ui').classList.add('hidden');
            document.getElementById('driver-status').classList.add('hidden');
            document.getElementById('parent-status').classList.add('hidden');
            
            // Close all modals
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
            
            // Show login screen
            document.getElementById('login-screen').classList.remove('hidden');
            
            showToast('Logged Out', 'You have been logged out successfully', 'info');
        }

        // Initialize touch handling for bottom sheet
        document.getElementById('bottom-sheet').addEventListener('touchstart', handleTouchStart, { passive: false });
        document.getElementById('bottom-sheet').addEventListener('touchmove', handleTouchMove, { passive: false });
        document.getElementById('bottom-sheet').addEventListener('touchend', handleTouchEnd, { passive: false });

        let touchStartY = 0;
        let touchCurrentY = 0;
        let isDragging = false;

        function handleTouchStart(e) {
            touchStartY = e.touches[0].clientY;
            touchCurrentY = touchStartY;
            isDragging = true;
        }

        function handleTouchMove(e) {
            if (!isDragging) return;
            touchCurrentY = e.touches[0].clientY;
            const deltaY = touchCurrentY - touchStartY;
            
            if (deltaY > 0) {
                e.preventDefault();
                const sheet = document.getElementById('bottom-sheet');
                const maxDelta = 200;
                const progress = Math.min(deltaY / maxDelta, 1);
                sheet.style.transform = `translateY(calc(100% - 60px + ${progress * 60}px))`;
                sheet.style.transition = 'none';
            }
        }

        function handleTouchEnd() {
            if (!isDragging) return;
            isDragging = false;
            
            const deltaY = touchCurrentY - touchStartY;
            const sheet = document.getElementById('bottom-sheet');
            sheet.style.transition = 'transform 0.3s ease';
            
            if (deltaY > 100) {
                collapseBottomSheet();
            } else {
                expandBottomSheet();
            }
        }
    </script>
</body>
</html>