<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BusTrack | Tanzania School Bus Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <style>
        :root {
            --primary-blue: #1e3a8a;
            --secondary-blue: #1d4ed8;
            --accent-blue: #3b82f6;
            --gradient-start: #1e3a8a;
            --gradient-end: #1e40af;
            --success-green: #10b981;
            --warning-yellow: #f59e0b;
            --danger-red: #ef4444;
        }
        
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        
        #map { 
            position: absolute; 
            top: 0; 
            bottom: 0; 
            width: 100%; 
            z-index: 0;
        }
        
        /* Language Dropdown */
        .language-dropdown {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
        }
        
        .language-btn {
            background: white;
            border: 2px solid var(--primary-blue);
            border-radius: 12px;
            padding: 8px 16px;
            font-weight: 600;
            color: var(--primary-blue);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .language-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }
        
        .language-btn.active {
            background: var(--primary-blue);
            color: white;
        }
        
        .language-dropdown-content {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            min-width: 150px;
            margin-top: 8px;
            overflow: hidden;
            opacity: 0;
            transform: translateY(-10px);
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1002;
        }
        
        .language-dropdown-content.show {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }
        
        .language-option {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .language-option:last-child {
            border-bottom: none;
        }
        
        .language-option:hover {
            background: #f3f4f6;
        }
        
        /* Login Screen */
        .login-screen {
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary-blue);
            border: 2px solid var(--primary-blue);
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .btn-secondary:hover {
            background: rgba(37, 99, 235, 0.05);
        }
        
        /* Role Selection */
        .role-option {
            flex: 1;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .role-option:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }
        
        .role-option.selected {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }
        
        .role-icon {
            font-size: 24px;
            margin-bottom: 12px;
            color: var(--primary-blue);
        }
        
        /* Bottom Sheet */
        .bottom-sheet {
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1000;
            max-height: 85vh;
            overflow-y: auto;
            overscroll-behavior: contain;
        }
        
        .glass-nav {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
        }
        
        .bottom-sheet-handle {
            width: 40px;
            height: 5px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        /* Animations */
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .slide-up {
            animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .status-present {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-absent {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status-picked {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-dropped {
            background: #fef3c7;
            color: #92400e;
        }
        
        /* Child List Items */
        .child-item {
            padding: 12px;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
        }
        
        .child-item:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-left: 4px solid var(--accent-blue);
            max-width: 320px;
            animation: slideUp 0.3s ease-out;
            display: none;
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 4000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            display: none;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            display: none;
        }
        
        /* Bus Marker */
        .bus-marker {
            position: relative;
        }
        
        .bus-marker-inner {
            position: relative;
            background: white;
            padding: 12px;
            border-radius: 50%;
            border: 4px solid var(--primary-blue);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        .bus-marker-pulse {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-blue);
            border-radius: 50%;
            opacity: 0.3;
            animation: pulse 2s infinite;
        }
        
        /* Stop Marker */
        .stop-marker {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 3px solid;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            background: white;
        }
        
        .stop-marker.completed {
            background: #10B981 !important;
            border-color: #10B981 !important;
            color: white !important;
        }
        
        .stop-marker.current {
            background: #3B82F6 !important;
            border-color: #3B82F6 !important;
            color: white !important;
            animation: pulse 1.5s infinite;
        }
        
        /* Stat Card */
        .stat-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .stat-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }
        
        /* Progress Bar */
        .progress-bar {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        /* Route Line */
        .route-line {
            stroke-dasharray: 10, 10;
            animation: dash 20s linear infinite;
        }
        
        @keyframes dash {
            to {
                stroke-dashoffset: -1000;
            }
        }
        
        /* Swipe Hint */
        .swipe-hint {
            position: absolute;
            bottom: 100px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 10;
            pointer-events: none;
        }
        
        .swipe-hint-content {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 12px 20px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .swipe-hint-arrow {
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        /* Offline Indicator */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ef4444;
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 10000;
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Offline Indicator -->
    <div id="offline-indicator" class="offline-indicator">
        <i class="fas fa-wifi-slash mr-2"></i>
        <span id="offline-text">You are offline. Some features may be limited.</span>
    </div>

    <!-- Language Dropdown -->
    <div class="language-dropdown" id="languageDropdown">
        <button class="language-btn" id="languageBtn">
            <i class="fas fa-globe"></i>
            <span id="current-language">English</span>
            <i class="fas fa-chevron-down"></i>
        </button>
        <div class="language-dropdown-content" id="languageDropdownContent">
            <div class="language-option" onclick="changeLanguage('en')">
                <span>ðŸ‡ºðŸ‡¸ English</span>
            </div>
            <div class="language-option" onclick="changeLanguage('sw')">
                <span>ðŸ‡¹ðŸ‡¿ Kiswahili</span>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="login-screen">
        <div class="text-center text-white animate__animated animate__fadeIn">
            <div class="w-24 h-24 bg-white rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-2xl animate__animated animate__pulse animate__infinite">
                <i class="fas fa-bus text-4xl" style="background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
            </div>
            <h1 class="text-5xl font-black mb-4 animate__animated animate__fadeInDown">BusTrack</h1>
            <p class="text-white/90 text-lg mb-12 animate__animated animate__fadeIn animate__delay-1s" id="loading-subtitle">Safe journeys, happy parents</p>
            
            <div class="w-64 h-2 bg-white/30 rounded-full overflow-hidden mx-auto animate__animated animate__fadeIn animate__delay-2s">
                <div id="loading-bar" class="h-full bg-white rounded-full w-0 transition-all duration-300"></div>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="login-screen hidden">
        <div class="login-card animate__animated animate__fadeInUp">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-bus text-2xl text-white"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800" id="login-title">Welcome to BusTrack</h2>
                <p class="text-gray-600 mt-2" id="login-subtitle">Choose your role to continue</p>
            </div>
            
            <!-- Role Selection -->
            <div class="flex gap-3 mb-6">
                <div class="role-option" onclick="selectRole('driver')">
                    <i class="fas fa-tachometer-alt role-icon"></i>
                    <div class="font-semibold text-gray-800" id="role-driver">Driver</div>
                    <div class="text-xs text-gray-500 mt-1" id="role-driver-desc">Manage routes</div>
                </div>
                <div class="role-option" onclick="selectRole('parent')">
                    <i class="fas fa-user-friends role-icon"></i>
                    <div class="font-semibold text-gray-800" id="role-parent">Parent</div>
                    <div class="text-xs text-gray-500 mt-1" id="role-parent-desc">Track children</div>
                </div>
            </div>
            
            <!-- Login Form -->
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label" for="email" id="label-email">Email Address</label>
                    <input type="email" id="email" class="form-input" placeholder="driver@school.com" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="password" id="label-password">Password</label>
                    <input type="password" id="password" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>
                
                <div class="form-group flex items-center justify-between">
                    <label class="flex items-center">
                        <input type="checkbox" id="remember-me" class="mr-2">
                        <span class="text-sm text-gray-600" id="remember-me-label">Remember me</span>
                    </label>
                    <a href="#" onclick="showForgotPassword()" class="text-sm text-blue-600 hover:text-blue-800 font-medium" id="forgot-password-link">Forgot password?</a>
                </div>
                
                <button type="submit" class="btn-primary mb-4" id="login-button">
                    Sign In
                </button>
                
                <div class="text-center">
                    <span class="text-gray-600 text-sm" id="no-account-text">Don't have an account?</span>
                    <a href="#" onclick="showSignup()" class="text-blue-600 hover:text-blue-800 font-medium text-sm ml-1" id="signup-link">Sign up</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Top Navigation -->
    <div id="top-nav" class="hidden absolute top-0 left-0 right-0 z-40 pt-8 px-4">
        <div class="flex justify-between items-center">
            <!-- Left: Back Button -->
            <button onclick="logout()" class="w-12 h-12 glass-nav rounded-2xl shadow-lg border border-white/30 flex items-center justify-center hover:scale-105 transition-transform">
                <i class="fas fa-sign-out-alt text-gray-700"></i>
            </button>
            
            <!-- Center: Status -->
            <div class="flex-1 mx-4">
                <div id="parent-status" class="hidden glass-nav rounded-2xl shadow-lg border border-white/30 p-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <div class="bg-green-500 w-3 h-3 rounded-full"></div>
                                <div class="bg-green-500 w-3 h-3 rounded-full absolute top-0 pulse-animation"></div>
                            </div>
                            <div>
                                <p class="text-xs uppercase tracking-wider text-gray-500 font-bold" id="status-eta">ETA</p>
                                <p class="font-bold text-gray-900"><span id="eta-time">--</span> <span id="eta-unit">min</span></p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-500" id="next-stop-label">Next Stop</p>
                            <p class="text-sm font-bold text-gray-900" id="next-stop-name">--</p>
                        </div>
                    </div>
                    <div class="progress-bar mt-2">
                        <div id="route-progress" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                
                <div id="driver-status" class="hidden glass-nav rounded-2xl shadow-lg border border-white/30 p-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs uppercase tracking-wider text-gray-500 font-bold" id="route-number-label">Route</p>
                            <p class="text-sm font-bold text-gray-900" id="route-name">--</p>
                        </div>
                        <div id="driver-status-badge" class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold uppercase">
                            <i class="fas fa-circle text-xs mr-1"></i>
                            <span id="status-offline">Offline</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right: User Menu -->
            <div class="flex gap-2">
                <button onclick="refreshData()" class="w-12 h-12 glass-nav rounded-2xl shadow-lg border border-white/30 flex items-center justify-center hover:scale-105 transition-transform">
                    <i class="fas fa-sync-alt text-gray-700"></i>
                </button>
                <button onclick="showUserMenu()" class="w-12 h-12 glass-nav rounded-2xl shadow-lg border border-white/30 flex items-center justify-center hover:scale-105 transition-transform">
                    <i class="fas fa-user text-gray-700"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Sheet -->
    <div id="bottom-sheet" class="hidden fixed bottom-0 left-0 right-0 glass-nav rounded-t-3xl shadow-2xl bottom-sheet"
         style="transform: translateY(calc(100% - 60px));">
        
        <!-- Handle -->
        <div class="flex justify-center pt-3 pb-2" onclick="toggleBottomSheet()">
            <div class="bottom-sheet-handle"></div>
        </div>
        
        <!-- Content -->
        <div class="px-5 pb-8">
            
            <!-- Driver UI -->
            <div id="driver-ui" class="hidden">
                <!-- Header -->
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900" id="driver-route-name">Route</h2>
                        <p class="text-gray-600 text-sm flex items-center gap-2 mt-1">
                            <i class="fas fa-route text-xs"></i>
                            <span id="driver-destination">--</span>
                        </p>
                    </div>
                    <div class="text-right">
                        <div id="current-time" class="text-lg font-black text-gray-900">--:--</div>
                        <div class="text-xs text-gray-500" id="local-time-label">Local Time</div>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div class="stat-card" onclick="showStudentList()">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-user-graduate text-sm text-blue-600"></i>
                            <p class="text-xs text-blue-600 font-semibold" id="stats-students">Students</p>
                        </div>
                        <p class="text-2xl font-bold text-blue-900"><span id="student-count">0</span><span class="text-sm text-blue-600">/0</span></p>
                        <div class="text-xs text-gray-500 mt-1" id="on-board-label">On board</div>
                    </div>
                    
                    <div class="stat-card" onclick="showNextStopDetails()">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-map-marker-alt text-sm text-yellow-600"></i>
                            <p class="text-xs text-yellow-600 font-semibold" id="next-stop-label-card">Next Stop</p>
                        </div>
                        <p class="text-lg font-bold text-yellow-900" id="driver-next-stop">--</p>
                        <div class="text-xs text-gray-500 mt-1" id="next-stop-eta">--</div>
                    </div>
                    
                    <div class="stat-card" onclick="showSchedule()">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-clock text-sm text-green-600"></i>
                            <p class="text-xs text-green-600 font-semibold" id="on-time-label">Status</p>
                        </div>
                        <p class="text-lg font-bold text-green-900" id="schedule-status">--</p>
                        <div class="text-xs text-gray-500 mt-1" id="ahead-schedule-label">Schedule</div>
                    </div>
                </div>
                
                <!-- Student Attendance Section -->
                <div class="bg-gray-50 rounded-2xl p-4 mb-6 border border-gray-200">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-gray-900 flex items-center gap-2">
                            <i class="fas fa-clipboard-check text-sm"></i>
                            <span id="attendance-title">Student Attendance</span>
                        </h3>
                        <span class="text-xs text-gray-500" id="present-count">0/0 present</span>
                    </div>
                    
                    <div class="space-y-2 max-h-60 overflow-y-auto" id="student-attendance-list">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-user-graduate text-2xl mb-2"></i>
                            <p>No students assigned</p>
                        </div>
                    </div>
                </div>
                
                <!-- Action Button -->
                <button id="toggle-trip" onclick="toggleTrip()" class="btn-primary hover:scale-[1.02] transition-transform">
                    <i class="fas fa-play mr-2"></i>
                    <span id="start-trip-button">Start Trip</span>
                </button>
            </div>
            
            <!-- Parent UI -->
            <div id="parent-ui" class="hidden">
                <!-- Child Info -->
                <div class="flex items-center gap-4 mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl border border-blue-200">
                    <img id="child-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Child" class="w-16 h-16 rounded-2xl shadow-lg" alt="Child">
                    <div class="flex-1">
                        <h2 class="text-xl font-bold text-gray-900" id="child-name">Child's Journey</h2>
                        <p class="text-gray-600 text-sm flex items-center gap-2 mt-1">
                            <i class="fas fa-bus text-xs"></i>
                            <span id="bus-info">Bus -- â€¢ Driver: --</span>
                        </p>
                    </div>
                    <div class="relative" onclick="toggleChildStatus()">
                        <div class="bg-gray-400 w-4 h-4 rounded-full shadow-lg"></div>
                    </div>
                </div>
                
                <!-- Child Status Controls -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button onclick="markChildPicked()" class="stat-card text-center hover:scale-105 transition-transform" id="picked-button">
                        <i class="fas fa-hand-paper text-blue-600 text-lg mb-2"></i>
                        <p class="text-xs font-semibold text-gray-900">Picked Up</p>
                    </button>
                    
                    <button onclick="markChildDropped()" class="stat-card text-center hover:scale-105 transition-transform" id="dropped-button">
                        <i class="fas fa-home text-green-600 text-lg mb-2"></i>
                        <p class="text-xs font-semibold text-gray-900">Dropped Off</p>
                    </button>
                </div>
                
                <!-- Quick Stats -->
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div class="stat-card">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-route text-sm text-blue-600"></i>
                            <p class="text-xs text-blue-600 font-semibold" id="distance-label">Distance</p>
                        </div>
                        <p class="text-xl font-bold text-blue-900">--<span class="text-sm text-blue-600"> km</span></p>
                    </div>
                    
                    <div class="stat-card">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-clock text-sm text-yellow-600"></i>
                            <p class="text-xs text-yellow-600 font-semibold" id="eta-label">ETA</p>
                        </div>
                        <p class="text-xl font-bold text-yellow-900" id="parent-eta">--<span class="text-sm text-yellow-600"> min</span></p>
                    </div>
                    
                    <div class="stat-card">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-temperature-high text-sm text-green-600"></i>
                            <p class="text-xs text-green-600 font-semibold" id="temp-label">Status</p>
                        </div>
                        <p class="text-xl font-bold text-green-900" id="child-status">--</p>
                    </div>
                </div>
                
                <!-- Journey Timeline -->
                <div class="bg-gray-50 rounded-2xl p-4 mb-6 border border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-gray-900" id="journey-title">Today's Journey</h3>
                        <span class="text-xs text-gray-500" id="journey-status">--</span>
                    </div>
                    
                    <div class="relative">
                        <!-- Timeline line -->
                        <div class="absolute left-6 top-0 bottom-0 w-0.5 bg-gray-300"></div>
                        
                        <!-- Timeline items -->
                        <div class="space-y-6" id="timeline-items">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-route text-2xl mb-2"></i>
                                <p>No journey data available</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="grid grid-cols-3 gap-3">
                    <button onclick="callDriver()" class="stat-card text-center hover:scale-105 transition-transform">
                        <i class="fas fa-phone-alt text-blue-600 text-lg mb-2"></i>
                        <p class="text-xs font-semibold text-gray-900" id="call-driver-button">Call Driver</p>
                    </button>
                    
                    <button onclick="showNotifications()" class="stat-card text-center hover:scale-105 transition-transform">
                        <i class="fas fa-bell text-yellow-600 text-lg mb-2"></i>
                        <p class="text-xs font-semibold text-gray-900" id="alerts-button">Alerts</p>
                    </button>
                    
                    <button onclick="showHistory()" class="stat-card text-center hover:scale-105 transition-transform">
                        <i class="fas fa-history text-green-600 text-lg mb-2"></i>
                        <p class="text-xs font-semibold text-gray-900" id="history-button">History</p>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Swipe Hint -->
    <div id="swipe-hint" class="swipe-hint hidden">
        <div class="swipe-hint-content animate__animated animate__fadeInUp">
            <i class="fas fa-arrow-up text-blue-600 swipe-hint-arrow"></i>
            <span id="swipe-hint-text">Swipe up for more details</span>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast hidden">
        <div class="flex items-center gap-3">
            <i id="toast-icon" class="fas fa-info-circle text-blue-500"></i>
            <div class="flex-1">
                <p class="font-semibold text-gray-900" id="toast-title">Notification</p>
                <p class="text-sm text-gray-600" id="toast-message"></p>
            </div>
            <button onclick="hideToast()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <p class="text-gray-700 font-medium" id="loading-text">Loading...</p>
    </div>

    <!-- Sign Up Modal -->
    <div id="signup-modal" class="modal">
        <div class="modal-content animate__animated animate__fadeInUp">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-900" id="signup-title">Create Account</h3>
                <button onclick="hideSignup()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="signup-form">
                <div class="form-group">
                    <label class="form-label" id="signup-role-label">Role</label>
                    <div class="flex gap-3">
                        <div class="role-option" onclick="selectSignupRole('driver')">
                            <i class="fas fa-tachometer-alt role-icon"></i>
                            <div class="font-semibold text-gray-800" id="signup-driver">Driver</div>
                        </div>
                        <div class="role-option" onclick="selectSignupRole('parent')">
                            <i class="fas fa-user-friends role-icon"></i>
                            <div class="font-semibold text-gray-800" id="signup-parent">Parent</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="signup-name" id="signup-name-label">Full Name</label>
                    <input type="text" id="signup-name" class="form-input" placeholder="Enter your full name" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="signup-email" id="signup-email-label">Email Address</label>
                    <input type="email" id="signup-email" class="form-input" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="signup-password" id="signup-password-label">Password</label>
                    <input type="password" id="signup-password" class="form-input" placeholder="Create password" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="signup-confirm" id="signup-confirm-label">Confirm Password</label>
                    <input type="password" id="signup-confirm" class="form-input" placeholder="Confirm password" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="signup-phone" id="signup-phone-label">Phone Number</label>
                    <input type="tel" id="signup-phone" class="form-input" placeholder="+255 XXX XXX XXX" required>
                </div>
                
                <!-- Child Details Section (for parents only) -->
                <div id="child-details-section" class="hidden">
                    <div class="border-t border-gray-200 my-4 pt-4">
                        <h4 class="font-semibold text-gray-800 mb-3" id="child-details-title">Child Details</h4>
                        
                        <div class="form-group">
                            <label class="form-label" for="child-name-input" id="child-name-label">Child's Name</label>
                            <input type="text" id="child-name-input" class="form-input" placeholder="Child's name" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="child-grade" id="child-grade-label">Grade</label>
                            <select id="child-grade" class="form-input" required>
                                <option value="">Select grade</option>
                                <option value="1">Grade 1</option>
                                <option value="2">Grade 2</option>
                                <option value="3">Grade 3</option>
                                <option value="4">Grade 4</option>
                                <option value="5">Grade 5</option>
                                <option value="6">Grade 6</option>
                                <option value="7">Grade 7</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="child-school" id="child-school-label">School</label>
                            <select id="child-school" class="form-input" required>
                                <option value="">Select school</option>
                                <option value="downtown">Downtown School</option>
                                <option value="lincoln">Lincoln School</option>
                                <option value="central">Central School</option>
                                <option value="primary">Primary School</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="child-bus" id="child-bus-label">Bus Number</label>
                            <select id="child-bus" class="form-input" required>
                                <option value="">Select bus</option>
                                <option value="BUS-101">Bus 101</option>
                                <option value="BUS-102">Bus 102</option>
                                <option value="BUS-103">Bus 103</option>
                                <option value="BUS-104">Bus 104</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="flex items-center">
                        <input type="checkbox" id="terms" class="mr-2" required>
                        <span class="text-sm text-gray-600" id="terms-label">I agree to the <a href="#" onclick="showTerms()" class="text-blue-600">Terms & Conditions</a></span>
                    </label>
                </div>
            </form>
            
            <button onclick="createAccount()" class="btn-primary mb-4 hover:scale-[1.02] transition-transform" id="signup-create-button">Create Account</button>
            <button onclick="hideSignup()" class="btn-secondary hover:scale-[1.02] transition-transform" id="signup-cancel-button">Cancel</button>
        </div>
    </div>

    <!-- User Menu Modal -->
    <div id="user-menu-modal" class="modal">
        <div class="modal-content animate__animated animate__fadeInUp">
            <div class="text-center mb-6">
                <img id="user-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=User" class="w-20 h-20 rounded-full mx-auto mb-4 border-4 border-white shadow-lg" alt="User">
                <h3 class="text-xl font-bold text-gray-900" id="user-name">--</h3>
                <p class="text-gray-600 text-sm" id="user-role">--</p>
            </div>
            
            <div class="space-y-2">
                <button onclick="showProfile()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-100 transition-colors">
                    <i class="fas fa-user text-gray-600"></i>
                    <span class="font-medium text-gray-800" id="menu-profile">Profile</span>
                </button>
                
                <button onclick="showSettings()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-100 transition-colors">
                    <i class="fas fa-cog text-gray-600"></i>
                    <span class="font-medium text-gray-800" id="menu-settings">Settings</span>
                </button>
                
                <button onclick="showHelp()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-100 transition-colors">
                    <i class="fas fa-question-circle text-gray-600"></i>
                    <span class="font-medium text-gray-800" id="menu-help">Help & Support</span>
                </button>
                
                <div class="border-t border-gray-200 my-3"></div>
                
                <button onclick="logout()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-red-50 text-red-600 transition-colors">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="font-medium" id="menu-logout">Log Out</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Student List Modal -->
    <div id="student-list-modal" class="modal">
        <div class="modal-content animate__animated animate__fadeInUp">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-900" id="student-list-title">Student List</h3>
                <button onclick="hideStudentList()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-2 max-h-96 overflow-y-auto" id="student-list">
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-user-graduate text-2xl mb-2"></i>
                    <p>No students available</p>
                </div>
            </div>
            
            <div class="mt-4 flex gap-3">
                <button onclick="markAllPresent()" class="btn-primary flex-1 hover:scale-[1.02] transition-transform" id="mark-all-present-button">
                    Mark All Present
                </button>
                <button onclick="hideStudentList()" class="btn-secondary flex-1 hover:scale-[1.02] transition-transform" id="close-list-button">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Floating Action Buttons -->
    <div id="fab-container" class="hidden absolute bottom-24 right-4 z-40 space-y-3">
        <button onclick="locateBus()" class="w-14 h-14 glass-nav rounded-2xl shadow-xl border border-white/30 flex items-center justify-center hover:scale-110 transition-transform">
            <i class="fas fa-location-arrow text-gray-700"></i>
        </button>
        <button onclick="shareLocation()" class="w-14 h-14 glass-nav rounded-2xl shadow-xl border border-white/30 flex items-center justify-center hover:scale-110 transition-transform" id="share-location-btn">
            <i class="fas fa-share-alt text-gray-700"></i>
        </button>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            APP_NAME: 'BusTrack',
            VERSION: '1.0.0',
            DEFAULT_LOCATION: {
                lat: -6.7924,
                lng: 39.2083,
                zoom: 13
            },
            REFRESH_INTERVAL: 10000, // 10 seconds
            LOCATION_ACCURACY: 10, // meters
            MAX_LOCATION_AGE: 30000, // 30 seconds
            OFFLINE_TIMEOUT: 5000 // 5 seconds
        };

        // ==================== LANGUAGE MANAGEMENT ====================
        const translations = {
            en: {
                // Loading screen
                'loading-subtitle': 'Safe journeys, happy parents',
                'login-title': 'Welcome to BusTrack',
                'login-subtitle': 'Choose your role to continue',
                'role-driver': 'Driver',
                'role-driver-desc': 'Manage routes',
                'role-parent': 'Parent',
                'role-parent-desc': 'Track children',
                'label-email': 'Email Address',
                'label-password': 'Password',
                'remember-me-label': 'Remember me',
                'forgot-password-link': 'Forgot password?',
                'login-button': 'Sign In',
                'no-account-text': 'Don\'t have an account?',
                'signup-link': 'Sign up',
                // Status labels
                'status-eta': 'ETA',
                'eta-unit': 'min',
                'next-stop-label': 'Next Stop',
                'route-number-label': 'Route',
                'status-offline': 'Offline',
                'status-online': 'Online',
                'local-time-label': 'Local Time',
                'stats-students': 'Students',
                'on-board-label': 'On board',
                'next-stop-label-card': 'Next Stop',
                'on-time-label': 'Status',
                'ahead-schedule-label': 'Schedule',
                'attendance-title': 'Student Attendance',
                'present-count': '0/0 present',
                'start-trip-button': 'Start Trip',
                'stop-trip-button': 'Stop Trip',
                'child-name': 'Child\'s Journey',
                'bus-info': 'Bus -- â€¢ Driver: --',
                'picked-button': 'Picked Up',
                'dropped-button': 'Dropped Off',
                'distance-label': 'Distance',
                'eta-label': 'ETA',
                'temp-label': 'Status',
                'journey-title': 'Today\'s Journey',
                'journey-status': '--',
                'call-driver-button': 'Call Driver',
                'alerts-button': 'Alerts',
                'history-button': 'History',
                // Sign up modal
                'signup-title': 'Create Account',
                'signup-role-label': 'Role',
                'signup-driver': 'Driver',
                'signup-parent': 'Parent',
                'signup-name-label': 'Full Name',
                'signup-email-label': 'Email Address',
                'signup-password-label': 'Password',
                'signup-confirm-label': 'Confirm Password',
                'signup-phone-label': 'Phone Number',
                'child-details-title': 'Child Details',
                'child-name-label': 'Child\'s Name',
                'child-grade-label': 'Grade',
                'child-school-label': 'School',
                'child-bus-label': 'Bus Number',
                'terms-label': 'I agree to the Terms & Conditions',
                'signup-create-button': 'Create Account',
                'signup-cancel-button': 'Cancel',
                // User menu
                'menu-profile': 'Profile',
                'menu-settings': 'Settings',
                'menu-help': 'Help & Support',
                'menu-logout': 'Log Out',
                // Student list
                'student-list-title': 'Student List',
                'mark-all-present-button': 'Mark All Present',
                'close-list-button': 'Close',
                // Toast messages
                'loading-text': 'Loading...',
                'offline-text': 'You are offline. Some features may be limited.',
                'swipe-hint-text': 'Swipe up for more details',
                // Status messages
                'status-waiting': 'Waiting',
                'status-picked': 'Picked Up',
                'status-dropped': 'Dropped Off',
                'status-ontime': 'On Time',
                'status-delayed': 'Delayed',
                'status-ahead': 'Ahead',
                'status-notstarted': 'Not Started'
            },
            sw: {
                // Loading screen
                'loading-subtitle': 'Safari salama, wazazi wenye furaha',
                'login-title': 'Karibu BusTrack',
                'login-subtitle': 'Chagua jukumu lako kuendelea',
                'role-driver': 'Dereva',
                'role-driver-desc': 'Dhibiti njia',
                'role-parent': 'Mzazi',
                'role-parent-desc': 'Fuatilia watoto',
                'label-email': 'Barua pepe',
                'label-password': 'Nenosiri',
                'remember-me-label': 'Nikumbuke',
                'forgot-password-link': 'Umesahau nenosiri?',
                'login-button': 'Ingia',
                'no-account-text': 'Huna akaunti?',
                'signup-link': 'Jisajili',
                // Status labels
                'status-eta': 'ETA',
                'eta-unit': 'dak',
                'next-stop-label': 'Kituo kifuatacho',
                'route-number-label': 'Njia',
                'status-offline': 'Haijaandaliwa',
                'status-online': 'Imeandaliwa',
                'local-time-label': 'Muda wa ndani',
                'stats-students': 'Wanafunzi',
                'on-board-label': 'Kwenye basi',
                'next-stop-label-card': 'Kituo kifuatacho',
                'on-time-label': 'Hali',
                'ahead-schedule-label': 'Ratiba',
                'attendance-title': 'Ukaguzi wa Uwepo',
                'present-count': '0/0 wapo',
                'start-trip-button': 'Anza Safari',
                'stop-trip-button': 'Acha Safari',
                'child-name': 'Safari ya Mtoto',
                'bus-info': 'Basi -- â€¢ Dereva: --',
                'picked-button': 'Amepokewa',
                'dropped-button': 'Ameachwa',
                'distance-label': 'Umbali',
                'eta-label': 'ETA',
                'temp-label': 'Hali',
                'journey-title': 'Safari ya Leo',
                'journey-status': '--',
                'call-driver-button': 'Piga Dereva',
                'alerts-button': 'Arifa',
                'history-button': 'Historia',
                // Sign up modal
                'signup-title': 'Jisajili Akaunti',
                'signup-role-label': 'Jukumu',
                'signup-driver': 'Dereva',
                'signup-parent': 'Mzazi',
                'signup-name-label': 'Jina kamili',
                'signup-email-label': 'Barua pepe',
                'signup-password-label': 'Nenosiri',
                'signup-confirm-label': 'Thibitisha Nenosiri',
                'signup-phone-label': 'Namba ya simu',
                'child-details-title': 'Maelezo ya Mtoto',
                'child-name-label': 'Jina la mtoto',
                'child-grade-label': 'Darasa',
                'child-school-label': 'Shule',
                'child-bus-label': 'Namba ya basi',
                'terms-label': 'Nakubali Sheria na Masharti',
                'signup-create-button': 'Unda Akaunti',
                'signup-cancel-button': 'Ghairi',
                // User menu
                'menu-profile': 'Wasifu',
                'menu-settings': 'Mipangilio',
                'menu-help': 'Usaidizi',
                'menu-logout': 'Toka',
                // Student list
                'student-list-title': 'Orodha ya Wanafunzi',
                'mark-all-present-button': 'Weka Wote Wapo',
                'close-list-button': 'Funga',
                // Toast messages
                'loading-text': 'Inapakia...',
                'offline-text': 'Uko nje ya mtandao. Baadhi ya huduma zinaweza kuwa na mipaka.',
                'swipe-hint-text': 'Sogeza juu kwa maelezo zaidi',
                // Status messages
                'status-waiting': 'Inasubiri',
                'status-picked': 'Imepokewa',
                'status-dropped': 'Imeachwa',
                'status-ontime': 'Kwa Wakati',
                'status-delayed': 'Imechelewa',
                'status-ahead': 'Mbele',
                'status-notstarted': 'Haijaanza'
            }
        };

        let currentLanguage = 'sw'; // Default to Swahili for Tanzania

        // ==================== APPLICATION STATE ====================
        let map = null;
        let busMarker = null;
        let stopMarkers = [];
        let routeLine = null;
        let currentUser = null;
        let currentRole = null;
        let selectedRole = null;
        let signupRole = null;
        let isDriving = false;
        let currentTrip = null;
        let routeStops = [];
        let currentStopIndex = 0;
        let busLocation = { ...CONFIG.DEFAULT_LOCATION };
        let students = [];
        let refreshInterval = null;
        let locationWatchId = null;
        let lastLocationUpdate = null;
        let isOnline = navigator.onLine;

        // ==================== INITIALIZATION ====================
        window.addEventListener('DOMContentLoaded', () => {
            setupLanguageDropdown();
            setupOfflineDetection();
            checkExistingSession();
        });

        function setupLanguageDropdown() {
            const languageBtn = document.getElementById('languageBtn');
            const dropdownContent = document.getElementById('languageDropdownContent');
            
            languageBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdownContent.classList.toggle('show');
                languageBtn.classList.toggle('active');
            });
            
            document.addEventListener('click', function(e) {
                if (!languageBtn.contains(e.target) && !dropdownContent.contains(e.target)) {
                    dropdownContent.classList.remove('show');
                    languageBtn.classList.remove('active');
                }
            });
            
            dropdownContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }

        function setupOfflineDetection() {
            window.addEventListener('online', () => {
                isOnline = true;
                document.getElementById('offline-indicator').style.display = 'none';
                showToast('Network', 'You are back online', 'success');
            });

            window.addEventListener('offline', () => {
                isOnline = false;
                document.getElementById('offline-indicator').style.display = 'block';
                showToast('Network', 'You are offline', 'warning');
            });
        }

        function checkExistingSession() {
            const session = localStorage.getItem('busTrack_session');
            if (session) {
                try {
                    const sessionData = JSON.parse(session);
                    if (sessionData.expires > Date.now()) {
                        const user = localStorage.getItem(`busTrack_user_${sessionData.userId}`);
                        if (user) {
                            currentUser = JSON.parse(user);
                            currentRole = currentUser.role;
                            initApp();
                            return;
                        }
                    }
                } catch (e) {
                    localStorage.removeItem('busTrack_session');
                }
            }
            
            simulateLoading();
        }

        function simulateLoading() {
            let progress = 0;
            const loadingBar = document.getElementById('loading-bar');
            const interval = setInterval(() => {
                progress += 2;
                loadingBar.style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('loading-screen').classList.add('hidden');
                        document.getElementById('login-screen').classList.remove('hidden');
                        changeLanguage(currentLanguage);
                    }, 500);
                }
            }, 30);
        }

        function changeLanguage(lang) {
            currentLanguage = lang;
            document.getElementById('current-language').textContent = lang === 'en' ? 'English' : 'Kiswahili';
            updateTextContent();
            document.getElementById('languageDropdownContent').classList.remove('show');
            document.getElementById('languageBtn').classList.remove('active');
        }

        function updateTextContent() {
            const lang = translations[currentLanguage];
            Object.keys(lang).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        element.placeholder = lang[key];
                    } else {
                        element.textContent = lang[key];
                    }
                }
            });
        }

        // ==================== AUTHENTICATION ====================
        function selectRole(role) {
            selectedRole = role;
            document.querySelectorAll('.role-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.closest('.role-option').classList.add('selected');
        }

        function selectSignupRole(role) {
            signupRole = role;
            document.querySelectorAll('#signup-modal .role-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.closest('.role-option').classList.add('selected');
            
            const childSection = document.getElementById('child-details-section');
            if (role === 'parent') {
                childSection.classList.remove('hidden');
            } else {
                childSection.classList.add('hidden');
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            
            if (!email || !password) {
                showToast('Error', 'Please fill in all fields', 'error');
                return;
            }
            
            if (!selectedRole) {
                showToast('Error', 'Please select a role', 'error');
                return;
            }
            
            showLoading();
            
            try {
                // In a real app, this would be an API call
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const userKey = `busTrack_user_${email.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const storedUser = localStorage.getItem(userKey);
                
                if (storedUser) {
                    const user = JSON.parse(storedUser);
                    
                    if (user.password === password && user.role === selectedRole) {
                        currentUser = user;
                        currentRole = user.role;
                        
                        const sessionData = {
                            userId: user.id,
                            email: user.email,
                            role: user.role,
                            loginTime: Date.now(),
                            expires: Date.now() + (rememberMe ? 30 * 24 * 60 * 60 * 1000 : 24 * 60 * 60 * 1000)
                        };
                        
                        localStorage.setItem('busTrack_session', JSON.stringify(sessionData));
                        
                        hideLoading();
                        document.getElementById('login-screen').classList.add('hidden');
                        initApp();
                        
                        showToast('Welcome', `Hello, ${user.name}!`, 'success');
                        return;
                    }
                }
                
                throw new Error('Invalid credentials');
            } catch (error) {
                hideLoading();
                showToast('Login Failed', 'Invalid email or password', 'error');
            }
        }

        async function createAccount() {
            const name = document.getElementById('signup-name').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const confirm = document.getElementById('signup-confirm').value;
            const phone = document.getElementById('signup-phone').value.trim();
            const terms = document.getElementById('terms').checked;
            
            if (!name || !email || !password || !confirm || !phone) {
                showToast('Error', 'Please fill in all fields', 'error');
                return;
            }
            
            if (!signupRole) {
                showToast('Error', 'Please select a role', 'error');
                return;
            }
            
            if (password !== confirm) {
                showToast('Error', 'Passwords do not match', 'error');
                return;
            }
            
            if (!terms) {
                showToast('Error', 'Please accept the terms and conditions', 'error');
                return;
            }
            
            showLoading();
            
            try {
                // Check if user exists
                const userKey = `busTrack_user_${email.replace(/[^a-zA-Z0-9]/g, '_')}`;
                if (localStorage.getItem(userKey)) {
                    throw new Error('User already exists');
                }
                
                // Create user object
                const newUser = {
                    id: `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    email: email,
                    password: password,
                    name: name,
                    role: signupRole,
                    phone: phone,
                    avatarSeed: name.replace(/\s+/g, ''),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                if (signupRole === 'driver') {
                    newUser.busNumber = 'BUS-' + (Math.floor(Math.random() * 900) + 100);
                    newUser.route = 'New Route';
                    newUser.licenseNumber = `DL-${Date.now().toString().substr(-6)}`;
                } else {
                    const childName = document.getElementById('child-name-input').value.trim();
                    const childGrade = document.getElementById('child-grade').value;
                    const childSchool = document.getElementById('child-school').value;
                    const childBus = document.getElementById('child-bus').value;
                    
                    if (!childName || !childGrade || !childSchool || !childBus) {
                        throw new Error('Please fill in all child details');
                    }
                    
                    newUser.children = [{
                        id: `child_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        name: childName,
                        grade: childGrade,
                        school: childSchool,
                        avatarSeed: childName.replace(/\s+/g, ''),
                        busNumber: childBus,
                        status: 'waiting',
                        present: false,
                        createdAt: new Date().toISOString()
                    }];
                    
                    // Add child to bus roster
                    addChildToBusRoster(newUser.children[0]);
                }
                
                // Save user
                localStorage.setItem(userKey, JSON.stringify(newUser));
                
                // Create session
                const sessionData = {
                    userId: newUser.id,
                    email: newUser.email,
                    role: newUser.role,
                    loginTime: Date.now(),
                    expires: Date.now() + (30 * 24 * 60 * 60 * 1000)
                };
                
                localStorage.setItem('busTrack_session', JSON.stringify(sessionData));
                
                currentUser = newUser;
                currentRole = signupRole;
                
                hideLoading();
                hideSignup();
                document.getElementById('login-screen').classList.add('hidden');
                initApp();
                
                showToast('Success', `Account created for ${name}`, 'success');
                
            } catch (error) {
                hideLoading();
                showToast('Error', error.message, 'error');
            }
        }

        function addChildToBusRoster(child) {
            const busRosterKey = `busTrack_roster_${child.busNumber}`;
            let roster = JSON.parse(localStorage.getItem(busRosterKey) || '[]');
            
            // Check if child already exists
            const existingIndex = roster.findIndex(r => r.id === child.id);
            if (existingIndex === -1) {
                roster.push({
                    id: child.id,
                    name: child.name,
                    grade: child.grade,
                    school: child.school,
                    status: 'waiting',
                    present: false,
                    pickupLocation: null,
                    dropoffLocation: null
                });
                
                localStorage.setItem(busRosterKey, JSON.stringify(roster));
            }
        }

        // ==================== APP INITIALIZATION ====================
        function initApp() {
            // Update UI
            document.getElementById('top-nav').classList.remove('hidden');
            document.getElementById('fab-container').classList.remove('hidden');
            document.getElementById('bottom-sheet').classList.remove('hidden');
            
            // Update user info
            updateUserInfo();
            
            // Initialize map
            initMap();
            
            // Load data
            loadInitialData();
            
            // Show role-specific UI
            if (currentRole === 'driver') {
                showDriverUI();
            } else {
                showParentUI();
            }
            
            // Expand bottom sheet with delay
            setTimeout(() => {
                expandBottomSheet();
                document.getElementById('swipe-hint').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('swipe-hint').classList.add('hidden');
                }, 5000);
            }, 500);
            
            // Start refresh interval
            startRefreshInterval();
            
            // Start clock
            updateTime();
            setInterval(updateTime, 1000);
        }

        function updateUserInfo() {
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = currentRole === 'driver' ? 'Driver' : 'Parent';
            document.getElementById('user-avatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUser.avatarSeed}`;
        }

        // ==================== MAP FUNCTIONS ====================
        function initMap() {
            map = L.map('map', {
                center: [busLocation.lat, busLocation.lng],
                zoom: busLocation.zoom,
                zoomControl: false,
                attributionControl: false,
                tap: false
            });

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);

            // Add current location control
            L.control.locate({
                position: 'bottomright',
                drawCircle: true,
                follow: false,
                setView: true,
                keepCurrentZoomLevel: true,
                markerStyle: {
                    weight: 1,
                    opacity: 0.8,
                    fillOpacity: 0.8
                },
                circleStyle: {
                    weight: 1,
                    stroke: true,
                    color: '#3B82F6',
                    opacity: 0.5,
                    fillOpacity: 0.2,
                    fillColor: '#3B82F6'
                },
                icon: 'fas fa-location-arrow',
                metric: true,
                strings: {
                    title: "Show my location",
                    popup: "You are within {distance} {unit} from this point",
                    outsideMapBoundsMsg: "You seem located outside the map bounds"
                },
                locateOptions: {
                    maxZoom: 16,
                    watch: false,
                    enableHighAccuracy: true,
                    maximumAge: 10000,
                    timeout: 10000
                }
            }).addTo(map);

            // Load route data
            loadRouteData();
        }

        function loadRouteData() {
            if (currentRole === 'driver') {
                const routeKey = `busTrack_route_${currentUser.busNumber}`;
                const routeData = JSON.parse(localStorage.getItem(routeKey));
                
                if (routeData) {
                    displayRoute(routeData);
                } else {
                    // Create default route
                    const defaultRoute = createDefaultRoute();
                    localStorage.setItem(routeKey, JSON.stringify(defaultRoute));
                    displayRoute(defaultRoute);
                }
            } else if (currentUser.children && currentUser.children[0]) {
                const busNumber = currentUser.children[0].busNumber;
                const routeKey = `busTrack_route_${busNumber}`;
                const routeData = JSON.parse(localStorage.getItem(routeKey));
                
                if (routeData) {
                    displayRoute(routeData);
                }
            }
        }

        function createDefaultRoute() {
            const stops = [
                { id: 1, name: "School", lat: -6.8100, lng: 39.2250, order: 1, students: 0 },
                { id: 2, name: "Stop 1", lat: -6.8000, lng: 39.2200, order: 2, students: 3 },
                { id: 3, name: "Stop 2", lat: -6.7924, lng: 39.2083, order: 3, students: 6 },
                { id: 4, name: "Stop 3", lat: -6.7850, lng: 39.2110, order: 4, students: 5 },
                { id: 5, name: "Stop 4", lat: -6.7780, lng: 39.2150, order: 5, students: 7 }
            ];
            
            return {
                id: `route_${Date.now()}`,
                busNumber: currentUser.busNumber,
                name: "School Route",
                stops: stops,
                schedule: {
                    morningStart: "07:00",
                    morningEnd: "08:30",
                    afternoonStart: "15:00",
                    afternoonEnd: "16:30"
                },
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
        }

        function displayRoute(routeData) {
            // Clear existing
            stopMarkers.forEach(marker => map.removeLayer(marker));
            stopMarkers = [];
            if (routeLine) map.removeLayer(routeLine);
            
            routeStops = routeData.stops || [];
            
            // Create route line
            const routeCoords = routeStops.map(stop => [stop.lat, stop.lng]);
            routeLine = L.polyline(routeCoords, {
                color: '#3B82F6',
                weight: 4,
                opacity: 0.7,
                dashArray: '10, 10',
                className: 'route-line'
            }).addTo(map);
            
            // Create stop markers
            routeStops.forEach((stop, index) => {
                const stopIcon = L.divIcon({
                    html: `
                        <div class="stop-marker">
                            ${index + 1}
                        </div>
                    `,
                    className: '',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                });
                
                const marker = L.marker([stop.lat, stop.lng], { icon: stopIcon }).addTo(map);
                marker.bindPopup(`
                    <div class="p-2">
                        <strong class="text-sm">${stop.name}</strong><br>
                        <span class="text-xs text-gray-600">Stop ${index + 1}</span><br>
                        <span class="text-xs text-gray-600">${stop.students || 0} students</span>
                    </div>
                `);
                stopMarkers.push(marker);
            });
            
            // Update UI
            if (currentRole === 'driver') {
                document.getElementById('driver-route-name').textContent = routeData.name;
                document.getElementById('driver-destination').textContent = routeData.name;
                document.getElementById('route-number-label').textContent = routeData.name;
                document.getElementById('route-name').textContent = routeData.name;
            }
            
            // Fit bounds
            if (routeCoords.length > 0) {
                const bounds = L.latLngBounds(routeCoords);
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        // ==================== LOCATION TRACKING ====================
        function startLocationTracking() {
            if (!navigator.geolocation) {
                showToast('Error', 'Geolocation is not supported by your browser', 'error');
                return;
            }
            
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };
            
            locationWatchId = navigator.geolocation.watchPosition(
                (position) => handleLocationUpdate(position),
                (error) => handleLocationError(error),
                options
            );
            
            isDriving = true;
            lastLocationUpdate = Date.now();
            updateDriverStatus(true);
            
            // Create trip record
            currentTrip = {
                id: `trip_${Date.now()}`,
                userId: currentUser.id,
                busNumber: currentUser.busNumber,
                startTime: new Date().toISOString(),
                status: 'active',
                locations: [],
                stopsVisited: []
            };
            
            saveTrip(currentTrip);
            showToast('Trip Started', 'Location tracking activated', 'success');
        }

        function stopLocationTracking() {
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
            
            isDriving = false;
            updateDriverStatus(false);
            
            // Update trip record
            if (currentTrip) {
                currentTrip.endTime = new Date().toISOString();
                currentTrip.status = 'completed';
                saveTrip(currentTrip);
                currentTrip = null;
            }
            
            showToast('Trip Stopped', 'Location tracking deactivated', 'info');
        }

        function handleLocationUpdate(position) {
            const { latitude, longitude, accuracy, speed, heading } = position.coords;
            
            busLocation = {
                lat: latitude,
                lng: longitude,
                accuracy: accuracy,
                speed: speed,
                heading: heading,
                timestamp: Date.now()
            };
            
            lastLocationUpdate = Date.now();
            
            // Update bus marker
            updateBusMarker();
            
            // Save location to trip
            if (currentTrip) {
                currentTrip.locations.push({
                    lat: latitude,
                    lng: longitude,
                    speed: speed,
                    heading: heading,
                    timestamp: new Date().toISOString()
                });
                
                // Keep only last 100 locations
                if (currentTrip.locations.length > 100) {
                    currentTrip.locations = currentTrip.locations.slice(-100);
                }
                
                saveTrip(currentTrip);
            }
            
            // Update bus location in storage for parents
            saveBusLocationForParents();
            
            // Update ETA calculations
            updateETA();
            
            // Check if approaching stops
            checkApproachingStops();
        }

        function handleLocationError(error) {
            let message = 'Unable to get your location';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Location permission denied';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Location information unavailable';
                    break;
                case error.TIMEOUT:
                    message = 'Location request timed out';
                    break;
            }
            showToast('Location Error', message, 'error');
        }

        function updateBusMarker() {
            if (!busMarker) {
                const busIcon = L.divIcon({
                    html: `
                        <div class="bus-marker">
                            <div class="bus-marker-pulse"></div>
                            <div class="bus-marker-inner">
                                <i class="fas fa-bus text-blue-600"></i>
                            </div>
                        </div>
                    `,
                    className: '',
                    iconSize: [48, 48],
                    iconAnchor: [24, 24]
                });
                
                busMarker = L.marker([busLocation.lat, busLocation.lng], { icon: busIcon }).addTo(map);
            } else {
                busMarker.setLatLng([busLocation.lat, busLocation.lng]);
            }
            
            // Update map view if driving
            if (isDriving) {
                map.setView([busLocation.lat, busLocation.lng], 16);
            }
        }

        function saveBusLocationForParents() {
            if (currentRole === 'driver') {
                const locationData = {
                    lat: busLocation.lat,
                    lng: busLocation.lng,
                    speed: busLocation.speed,
                    heading: busLocation.heading,
                    timestamp: busLocation.timestamp,
                    busNumber: currentUser.busNumber
                };
                
                localStorage.setItem(`busTrack_location_${currentUser.busNumber}`, JSON.stringify(locationData));
            }
        }

        function updateETA() {
            if (routeStops.length === 0) return;
            
            // Find nearest stop
            let nearestStop = null;
            let minDistance = Infinity;
            
            routeStops.forEach((stop, index) => {
                const distance = calculateDistance(
                    [busLocation.lat, busLocation.lng],
                    [stop.lat, stop.lng]
                );
                
                if (distance < minDistance && index > currentStopIndex) {
                    minDistance = distance;
                    nearestStop = { ...stop, index, distance };
                }
            });
            
            if (nearestStop) {
                // Calculate ETA based on distance and speed
                const speed = busLocation.speed || 30; // km/h
                const etaMinutes = Math.round((nearestStop.distance / speed) * 60);
                
                document.getElementById('eta-time').textContent = Math.max(1, etaMinutes);
                document.getElementById('parent-eta').textContent = Math.max(1, etaMinutes);
                document.getElementById('next-stop-name').textContent = nearestStop.name;
                document.getElementById('driver-next-stop').textContent = nearestStop.name;
                document.getElementById('next-stop-eta').textContent = `${Math.max(1, etaMinutes)} min`;
                
                // Update progress
                const progress = ((nearestStop.index) / routeStops.length) * 100;
                document.getElementById('route-progress').style.width = `${progress}%`;
            }
        }

        function checkApproachingStops() {
            if (routeStops.length === 0) return;
            
            routeStops.forEach((stop, index) => {
                const distance = calculateDistance(
                    [busLocation.lat, busLocation.lng],
                    [stop.lat, stop.lng]
                );
                
                // If within 100 meters of a stop
                if (distance < 0.1 && index > currentStopIndex) {
                    currentStopIndex = index;
                    
                    // Update stop marker
                    updateStopMarkers();
                    
                    // Show notification
                    showToast('Arriving', `Approaching ${stop.name}`, 'info');
                    
                    // Record stop visit
                    if (currentTrip) {
                        currentTrip.stopsVisited.push({
                            stopId: stop.id,
                            name: stop.name,
                            timestamp: new Date().toISOString()
                        });
                        saveTrip(currentTrip);
                    }
                }
            });
        }

        function updateStopMarkers() {
            stopMarkers.forEach((marker, index) => {
                const isCompleted = index < currentStopIndex;
                const isCurrent = index === currentStopIndex;
                
                const className = isCompleted ? 'completed' : isCurrent ? 'current' : '';
                
                const icon = L.divIcon({
                    html: `
                        <div class="stop-marker ${className}">
                            ${index + 1}
                        </div>
                    `,
                    className: '',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                });
                
                marker.setIcon(icon);
            });
        }

        function calculateDistance(point1, point2) {
            const lat1 = point1[0] || point1.lat;
            const lon1 = point1[1] || point1.lng;
            const lat2 = point2[0] || point2.lat;
            const lon2 = point2[1] || point2.lng;
            
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ==================== DRIVER UI FUNCTIONS ====================
        function showDriverUI() {
            document.getElementById('driver-status').classList.remove('hidden');
            document.getElementById('driver-ui').classList.remove('hidden');
            document.getElementById('parent-ui').classList.add('hidden');
            document.getElementById('parent-status').classList.add('hidden');
            
            // Load driver data
            loadDriverData();
            
            // Show share location button
            document.getElementById('share-location-btn').classList.remove('hidden');
        }

        function loadDriverData() {
            // Load students
            if (currentUser.busNumber) {
                const rosterKey = `busTrack_roster_${currentUser.busNumber}`;
                students = JSON.parse(localStorage.getItem(rosterKey) || '[]');
                
                document.getElementById('student-count').textContent = students.filter(s => s.present).length;
                document.getElementById('present-count').textContent = `${students.filter(s => s.present).length}/${students.length} present`;
                
                updateStudentAttendanceList();
            }
            
            // Update status
            updateDriverStatus(isDriving);
        }

        function updateDriverStatus(active) {
            const statusBadge = document.getElementById('driver-status-badge');
            const toggleButton = document.getElementById('toggle-trip');
            
            if (active) {
                statusBadge.innerHTML = '<i class="fas fa-circle text-xs mr-1 text-green-500"></i>' + translations[currentLanguage]['status-online'];
                statusBadge.className = 'bg-green-100 text-green-600 px-3 py-1 rounded-full text-xs font-bold uppercase';
                toggleButton.innerHTML = '<i class="fas fa-stop mr-2"></i><span>' + translations[currentLanguage]['stop-trip-button'] + '</span>';
            } else {
                statusBadge.innerHTML = '<i class="fas fa-circle text-xs mr-1"></i>' + translations[currentLanguage]['status-offline'];
                statusBadge.className = 'bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold uppercase';
                toggleButton.innerHTML = '<i class="fas fa-play mr-2"></i><span>' + translations[currentLanguage]['start-trip-button'] + '</span>';
            }
        }

        function toggleTrip() {
            if (isDriving) {
                stopLocationTracking();
            } else {
                startLocationTracking();
            }
        }

        function updateStudentAttendanceList() {
            const container = document.getElementById('student-attendance-list');
            container.innerHTML = '';
            
            if (students.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-user-graduate text-2xl mb-2"></i>
                        <p>No students assigned</p>
                    </div>
                `;
                return;
            }
            
            students.forEach(student => {
                const statusClass = student.present ? 'status-present' : 'status-absent';
                const statusText = student.present ? 'Present' : 'Absent';
                const statusIcon = student.present ? 'fa-check-circle' : 'fa-times-circle';
                
                const studentEl = document.createElement('div');
                studentEl.className = 'child-item';
                studentEl.onclick = () => toggleStudentPresence(student.id);
                studentEl.innerHTML = `
                    <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-gray-600"></i>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">${student.name}</span>
                            <span class="status-badge ${statusClass}">
                                <i class="fas ${statusIcon} text-xs"></i>
                                ${statusText}
                            </span>
                        </div>
                        <div class="text-xs text-gray-500">${student.grade} â€¢ ${student.school}</div>
                    </div>
                `;
                container.appendChild(studentEl);
            });
        }

        function toggleStudentPresence(studentId) {
            const studentIndex = students.findIndex(s => s.id === studentId);
            if (studentIndex !== -1) {
                students[studentIndex].present = !students[studentIndex].present;
                students[studentIndex].status = students[studentIndex].present ? 'picked' : 'waiting';
                students[studentIndex].updatedAt = new Date().toISOString();
                
                // Save to storage
                const rosterKey = `busTrack_roster_${currentUser.busNumber}`;
                localStorage.setItem(rosterKey, JSON.stringify(students));
                
                // Update UI
                updateStudentAttendanceList();
                
                // Show notification
                const message = students[studentIndex].present 
                    ? `${students[studentIndex].name} marked as present` 
                    : `${students[studentIndex].name} marked as absent`;
                showToast('Attendance Updated', message, 'success');
                
                // Notify parent
                notifyParent(students[studentIndex].id, students[studentIndex].present ? 'present' : 'absent');
            }
        }

        function markAllPresent() {
            students.forEach(student => {
                student.present = true;
                student.status = 'picked';
                student.updatedAt = new Date().toISOString();
            });
            
            const rosterKey = `busTrack_roster_${currentUser.busNumber}`;
            localStorage.setItem(rosterKey, JSON.stringify(students));
            
            updateStudentAttendanceList();
            showToast('All Marked Present', 'All students marked as present', 'success');
            
            // Notify all parents
            students.forEach(student => {
                notifyParent(student.id, 'present');
            });
        }

        // ==================== PARENT UI FUNCTIONS ====================
        function showParentUI() {
            document.getElementById('parent-status').classList.remove('hidden');
            document.getElementById('parent-ui').classList.remove('hidden');
            document.getElementById('driver-ui').classList.add('hidden');
            document.getElementById('driver-status').classList.add('hidden');
            
            // Hide share location button
            document.getElementById('share-location-btn').classList.add('hidden');
            
            // Load parent data
            loadParentData();
            
            // Start location updates
            startParentLocationUpdates();
        }

        function loadParentData() {
            if (currentUser.children && currentUser.children[0]) {
                const child = currentUser.children[0];
                
                document.getElementById('child-name').textContent = `${child.name}'s Journey`;
                document.getElementById('bus-info').textContent = `Bus ${child.busNumber} â€¢ Driver: --`;
                document.getElementById('child-avatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${child.avatarSeed}`;
                document.getElementById('child-status').textContent = getStatusText(child.status);
                
                // Load bus location
                updateBusLocationForParent(child.busNumber);
                
                // Update timeline
                updateTimeline();
            }
        }

        function updateBusLocationForParent(busNumber) {
            const locationData = JSON.parse(localStorage.getItem(`busTrack_location_${busNumber}`));
            
            if (locationData) {
                const age = Date.now() - locationData.timestamp;
                
                if (age < CONFIG.MAX_LOCATION_AGE) {
                    // Update ETA
                    updateETAForParent(locationData);
                } else {
                    document.getElementById('eta-time').textContent = '--';
                    document.getElementById('parent-eta').textContent = '--';
                }
            }
        }

        function updateETAForParent(locationData) {
            // This would calculate ETA based on distance to school
            // For now, we'll use a simple calculation
            const eta = Math.floor(Math.random() * 20) + 5; // 5-25 minutes
            document.getElementById('eta-time').textContent = eta;
            document.getElementById('parent-eta').textContent = eta;
        }

        function startParentLocationUpdates() {
            // Check bus location every 10 seconds
            setInterval(() => {
                if (currentUser.children && currentUser.children[0]) {
                    updateBusLocationForParent(currentUser.children[0].busNumber);
                }
            }, 10000);
        }

        function markChildPicked() {
            if (currentUser.children && currentUser.children[0]) {
                const child = currentUser.children[0];
                child.status = 'picked';
                child.updatedAt = new Date().toISOString();
                
                // Update in storage
                updateUserInStorage();
                
                // Update UI
                document.getElementById('child-status').textContent = getStatusText(child.status);
                
                showToast('Child Picked Up', `${child.name} marked as picked up`, 'success');
                
                // Notify driver
                notifyDriver(child.id, 'picked');
            }
        }

        function markChildDropped() {
            if (currentUser.children && currentUser.children[0]) {
                const child = currentUser.children[0];
                child.status = 'dropped';
                child.updatedAt = new Date().toISOString();
                
                // Update in storage
                updateUserInStorage();
                
                // Update UI
                document.getElementById('child-status').textContent = getStatusText(child.status);
                
                showToast('Child Dropped Off', `${child.name} marked as dropped at school`, 'success');
                
                // Notify driver
                notifyDriver(child.id, 'dropped');
            }
        }

        function updateUserInStorage() {
            const userKey = `busTrack_user_${currentUser.email.replace(/[^a-zA-Z0-9]/g, '_')}`;
            currentUser.updatedAt = new Date().toISOString();
            localStorage.setItem(userKey, JSON.stringify(currentUser));
        }

        function updateTimeline() {
            const container = document.getElementById('timeline-items');
            container.innerHTML = '';
            
            const now = new Date();
            const timelineData = [
                { time: '07:00 AM', title: 'Bus Departure', desc: 'From school', icon: 'bus', color: 'blue', status: 'completed' },
                { time: now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), title: 'Current Location', desc: 'En route', icon: 'location-arrow', color: 'yellow', status: 'current' },
                { time: '08:00 AM', title: 'Estimated Arrival', desc: 'At your location', icon: 'map-marker-alt', color: 'green', status: 'upcoming' }
            ];
            
            timelineData.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex items-center gap-4 relative';
                itemEl.innerHTML = `
                    <div class="w-12 h-12 bg-${item.color}-500 rounded-xl shadow-lg flex items-center justify-center z-10">
                        <i class="fas fa-${item.icon} text-white"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-bold text-gray-900">${item.title}</p>
                        <p class="text-sm text-gray-600">${item.desc}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-gray-900">${item.time.split(' ')[0]}</p>
                        <p class="text-xs text-gray-500">${item.time.split(' ')[1] || ''}</p>
                    </div>
                `;
                container.appendChild(itemEl);
            });
        }

        // ==================== UTILITY FUNCTIONS ====================
        function getStatusText(status) {
            return translations[currentLanguage][`status-${status}`] || status;
        }

        function notifyParent(childId, action) {
            // In a real app, this would send a push notification
            // For now, we'll create a notification in storage
            const notification = {
                id: `notif_${Date.now()}`,
                type: 'info',
                title: action === 'present' ? 'Student Present' : 'Student Absent',
                message: `Your child's attendance has been updated`,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            // Save notification
            saveNotification(notification);
        }

        function notifyDriver(childId, action) {
            // In a real app, this would send a notification to the driver
            // For now, we'll just log it
            console.log(`Driver notified: Child ${childId} ${action}`);
        }

        function saveNotification(notification) {
            const notifications = JSON.parse(localStorage.getItem('busTrack_notifications') || '[]');
            notifications.unshift(notification);
            
            // Keep only last 50 notifications
            if (notifications.length > 50) {
                notifications.pop();
            }
            
            localStorage.setItem('busTrack_notifications', JSON.stringify(notifications));
        }

        function saveTrip(trip) {
            const trips = JSON.parse(localStorage.getItem('busTrack_trips') || '[]');
            trips.unshift(trip);
            
            // Keep only last 100 trips
            if (trips.length > 100) {
                trips.pop();
            }
            
            localStorage.setItem('busTrack_trips', JSON.stringify(trips));
        }

        function loadInitialData() {
            // Load any initial data needed
        }

        function startRefreshInterval() {
            refreshInterval = setInterval(() => {
                refreshData();
            }, CONFIG.REFRESH_INTERVAL);
        }

        function refreshData() {
            if (currentRole === 'driver') {
                loadDriverData();
            } else {
                loadParentData();
            }
        }

        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function showToast(title, message, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            
            switch(type) {
                case 'success':
                    icon.className = 'fas fa-check-circle text-green-500';
                    break;
                case 'error':
                    icon.className = 'fas fa-exclamation-circle text-red-500';
                    break;
                case 'warning':
                    icon.className = 'fas fa-exclamation-triangle text-yellow-500';
                    break;
                default:
                    icon.className = 'fas fa-info-circle text-blue-500';
            }
            
            document.getElementById('toast-title').textContent = title;
            document.getElementById('toast-message').textContent = message;
            
            toast.classList.remove('hidden');
            
            setTimeout(hideToast, 4000);
        }

        function hideToast() {
            document.getElementById('toast').classList.add('hidden');
        }

        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('current-time').textContent = timeStr;
        }

        // ==================== UI CONTROLS ====================
        function locateBus() {
            if (map && busLocation) {
                map.setView([busLocation.lat, busLocation.lng], 16);
                showToast('Location', 'Centered on bus location', 'info');
            }
        }

        function shareLocation() {
            if (navigator.share && isDriving) {
                navigator.share({
                    title: 'Bus Location',
                    text: `Bus ${currentUser.busNumber} is currently at ${busLocation.lat.toFixed(6)}, ${busLocation.lng.toFixed(6)}`,
                    url: window.location.href
                }).catch(console.error);
            } else {
                showToast('Share', 'Copying location to clipboard', 'info');
                
                const locationText = `Bus ${currentUser.busNumber} Location: https://maps.google.com/?q=${busLocation.lat},${busLocation.lng}`;
                navigator.clipboard.writeText(locationText).then(() => {
                    showToast('Copied', 'Location copied to clipboard', 'success');
                });
            }
        }

        function toggleBottomSheet() {
            const sheet = document.getElementById('bottom-sheet');
            const transform = sheet.style.transform;
            
            if (transform.includes('0px')) {
                collapseBottomSheet();
            } else {
                expandBottomSheet();
            }
        }

        function expandBottomSheet() {
            document.getElementById('bottom-sheet').style.transform = 'translateY(0)';
        }

        function collapseBottomSheet() {
            document.getElementById('bottom-sheet').style.transform = 'translateY(calc(100% - 60px))';
        }

        // ==================== MODAL FUNCTIONS ====================
        function showSignup() {
            document.getElementById('signup-modal').style.display = 'flex';
        }

        function hideSignup() {
            document.getElementById('signup-modal').style.display = 'none';
        }

        function showUserMenu() {
            document.getElementById('user-menu-modal').style.display = 'flex';
        }

        function showStudentList() {
            document.getElementById('student-list-modal').style.display = 'flex';
            populateStudentList();
        }

        function hideStudentList() {
            document.getElementById('student-list-modal').style.display = 'none';
        }

        function populateStudentList() {
            const container = document.getElementById('student-list');
            container.innerHTML = '';
            
            if (students.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-user-graduate text-2xl mb-2"></i>
                        <p>No students available</p>
                    </div>
                `;
                return;
            }
            
            students.forEach(student => {
                const statusClass = student.present ? 'status-present' : 'status-absent';
                const statusText = student.present ? 'Present' : 'Absent';
                const statusIcon = student.present ? 'fa-check-circle' : 'fa-times-circle';
                
                const studentEl = document.createElement('div');
                studentEl.className = 'child-item';
                studentEl.onclick = () => toggleStudentPresence(student.id);
                studentEl.innerHTML = `
                    <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-gray-600"></i>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">${student.name}</span>
                            <span class="status-badge ${statusClass}">
                                <i class="fas ${statusIcon} text-xs"></i>
                                ${statusText}
                            </span>
                        </div>
                        <div class="text-xs text-gray-500">${student.grade} â€¢ ${student.school}</div>
                        <div class="text-xs text-gray-500 mt-1">Status: ${getStatusText(student.status)}</div>
                    </div>
                `;
                container.appendChild(studentEl);
            });
        }

        // ==================== OTHER FUNCTIONS ====================
        function callDriver() {
            if (currentUser.children && currentUser.children[0]) {
                const busNumber = currentUser.children[0].busNumber;
                showToast('Call Driver', `Calling driver of bus ${busNumber}...`, 'info');
                
                // In a real app, this would initiate a phone call
                setTimeout(() => {
                    showToast('Call Connected', 'You are now connected to the driver', 'success');
                }, 2000);
            }
        }

        function showNotifications() {
            const notifications = JSON.parse(localStorage.getItem('busTrack_notifications') || '[]');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                showToast('Notifications', `You have ${unreadCount} unread notifications`, 'info');
            } else {
                showToast('Notifications', 'No new notifications', 'info');
            }
        }

        function showHistory() {
            const trips = JSON.parse(localStorage.getItem('busTrack_trips') || '[]');
            if (trips.length > 0) {
                showToast('History', `You have ${trips.length} past trips`, 'info');
            } else {
                showToast('History', 'No trip history', 'info');
            }
        }

        function showForgotPassword() {
            showToast('Forgot Password', 'Please contact school administration', 'info');
        }

        function showProfile() {
            showToast('Profile', 'Profile page coming soon', 'info');
        }

        function showSettings() {
            showToast('Settings', 'Settings page coming soon', 'info');
        }

        function showHelp() {
            showToast('Help', 'Help center coming soon', 'info');
        }

        function showNextStopDetails() {
            showToast('Stop Details', 'Showing stop information', 'info');
        }

        function showSchedule() {
            showToast('Schedule', 'Showing route schedule', 'info');
        }

        function logout() {
            // Stop location tracking
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
            }
            
            // Clear intervals
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            // Clear session
            localStorage.removeItem('busTrack_session');
            
            // Reset state
            currentUser = null;
            currentRole = null;
            isDriving = false;
            
            // Hide app UI
            document.getElementById('top-nav').classList.add('hidden');
            document.getElementById('fab-container').classList.add('hidden');
            document.getElementById('bottom-sheet').classList.add('hidden');
            document.getElementById('driver-ui').classList.add('hidden');
            document.getElementById('parent-ui').classList.add('hidden');
            document.getElementById('driver-status').classList.add('hidden');
            document.getElementById('parent-status').classList.add('hidden');
            document.getElementById('swipe-hint').classList.add('hidden');
            
            // Close modals
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
            
            // Close language dropdown
            document.getElementById('languageDropdownContent').classList.remove('show');
            document.getElementById('languageBtn').classList.remove('active');
            
            // Show login screen
            document.getElementById('login-screen').classList.remove('hidden');
            
            showToast('Logged Out', 'You have been logged out successfully', 'info');
        }

        // Touch handling for bottom sheet
        let touchStartY = 0;
        let touchCurrentY = 0;
        let isDragging = false;

        document.getElementById('bottom-sheet').addEventListener('touchstart', function(e) {
            touchStartY = e.touches[0].clientY;
            touchCurrentY = touchStartY;
            isDragging = true;
            this.style.transition = 'none';
        }, { passive: true });

        document.getElementById('bottom-sheet').addEventListener('touchmove', function(e) {
            if (!isDragging) return;
            touchCurrentY = e.touches[0].clientY;
            const deltaY = touchCurrentY - touchStartY;
            
            if (deltaY > 0) {
                const maxDelta = 200;
                const progress = Math.min(deltaY / maxDelta, 1);
                this.style.transform = `translateY(calc(100% - 60px + ${progress * 60}px))`;
            }
        }, { passive: true });

        document.getElementById('bottom-sheet').addEventListener('touchend', function() {
            if (!isDragging) return;
            isDragging = false;
            
            const deltaY = touchCurrentY - touchStartY;
            this.style.transition = 'transform 0.3s ease';
            
            if (deltaY > 50) {
                collapseBottomSheet();
            } else {
                expandBottomSheet();
            }
        }, { passive: true });
    </script>
</body>
</html>
